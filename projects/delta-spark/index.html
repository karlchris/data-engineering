
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="All you need to know about Data Engineering, Data Warehousing and Data Platform.">
      
      
        <meta name="author" content="Karl Christian">
      
      
        <link rel="canonical" href="https://karlchris.github.io/data-engineering/projects/delta-spark/">
      
      
        <link rel="prev" href="../spark-iceberg/">
      
      
        <link rel="next" href="../spark-hudi/">
      
      
      <link rel="icon" href="../../assets/img/sqldeveloper-original.svg">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.5.24">
    
    
      
        <title>Delta Lake with Apache Spark - Data Engineering Works</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.6543a935.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      

  
  
  
  
  <style>:root{--md-annotation-icon:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 13h-4v4h-2v-4H7v-2h4V7h2v4h4m-5-9A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10A10 10 0 0 0 12 2Z"/></svg>');}</style>


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Fira+Sans:300,300i,400,400i,700,700i%7CFira+Code:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Fira Sans";--md-code-font:"Fira Code"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function n(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],n("js",new Date),n("config","G-"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&n("event","search",{search_term:this.value})}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");n("event","feedback",{page:t,data:e}),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){n("config","G-",{page_path:e.pathname})})});var e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=G-",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script>
  
    <script>var consent;"undefined"==typeof __md_analytics||(consent=__md_get("__consent"))&&consent.analytics&&__md_analytics()</script>
  

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#delta-lake-with-apache-spark" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Data Engineering Works" class="md-header__button md-logo" aria-label="Data Engineering Works" data-md-component="logo">
      
  <img src="../../assets/img/sqldeveloper-original.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Data Engineering Works
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Delta Lake with Apache Spark
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme)" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m14.3 16-.7-2h-3.2l-.7 2H7.8L11 7h2l3.2 9h-1.9M20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69m-9.15 3.96h2.3L12 9l-1.15 3.65Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="teal" data-md-color-accent="indigo"  aria-label="Switch to system preference"  type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Switch to system preference" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/karlchris/data-engineering" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    karlchris/data-engineering
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../" class="md-tabs__link">
          
  
    
  
  Projects

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../data-engineering/" class="md-tabs__link">
          
  
    
  
  Data Engineering

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../data-modeling/" class="md-tabs__link">
          
  
    
  
  Data Modeling

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../data-ingestion/" class="md-tabs__link">
          
  
    
  
  Data Ingestion

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../data-architecture/" class="md-tabs__link">
          
  
    
  
  Data Architecture

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../data-orchestration/" class="md-tabs__link">
          
  
    
  
  Data Orchestration

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../data-processing/" class="md-tabs__link">
          
  
    
  
  Data Processing

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../data-quality/" class="md-tabs__link">
          
  
    
  
  Data Quality

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../learning-python/" class="md-tabs__link">
          
  
    
  
  Python

        </a>
      </li>
    
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../author/" class="md-tabs__link">
        
  
    
  
  About me

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Data Engineering Works" class="md-nav__button md-logo" aria-label="Data Engineering Works" data-md-component="logo">
      
  <img src="../../assets/img/sqldeveloper-original.svg" alt="logo">

    </a>
    Data Engineering Works
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/karlchris/data-engineering" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    karlchris/data-engineering
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Projects
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2" id="__nav_2_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Projects
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../dbt-bq/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Running dbt and BigQuery using Docker
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../great-expectations-bq/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Automated Data Quality Testing with Great Expectations and BigQuery
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../airflow-k8s/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Deploying and Running Airflow on Kubernetes
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../gh-pages-gh-actions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Building Github Pages using Github Actions
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../flink-k8s/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Running Apache Flink on Kubernetes
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../spark-docker/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Running Spark using Docker Compose
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../kafka-ksql/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Querying Streaming Data in Kafka using ksql
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../spark-iceberg/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Apache Iceberg and PySpark
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Delta Lake with Apache Spark
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Delta Lake with Apache Spark
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#what-is-delta-lake" class="md-nav__link">
    <span class="md-ellipsis">
      What is Delta Lake
    </span>
  </a>
  
    <nav class="md-nav" aria-label="What is Delta Lake">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#lakehouse-architecture" class="md-nav__link">
    <span class="md-ellipsis">
      Lakehouse Architecture
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lakehouse-features" class="md-nav__link">
    <span class="md-ellipsis">
      Lakehouse Features
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#contents-of-delta-table" class="md-nav__link">
    <span class="md-ellipsis">
      Contents of Delta table
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Contents of Delta table">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#benefits-for-etl" class="md-nav__link">
    <span class="md-ellipsis">
      Benefits for ETL
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Benefits for ETL">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#query-optimization" class="md-nav__link">
    <span class="md-ellipsis">
      Query Optimization
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reliability" class="md-nav__link">
    <span class="md-ellipsis">
      Reliability
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#schema-enformement-and-evolution" class="md-nav__link">
    <span class="md-ellipsis">
      Schema Enformement and Evolution
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Schema Enformement and Evolution">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#schema-evolution" class="md-nav__link">
    <span class="md-ellipsis">
      Schema Evolution
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#time-travel" class="md-nav__link">
    <span class="md-ellipsis">
      Time Travel
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scalability" class="md-nav__link">
    <span class="md-ellipsis">
      Scalability
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Scalability">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#partitioning" class="md-nav__link">
    <span class="md-ellipsis">
      Partitioning
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#data-clustering" class="md-nav__link">
    <span class="md-ellipsis">
      Data Clustering
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#query-engine-support" class="md-nav__link">
    <span class="md-ellipsis">
      Query Engine Support
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#optimizing-delta-lake" class="md-nav__link">
    <span class="md-ellipsis">
      Optimizing Delta Lake
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Optimizing Delta Lake">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#offline-optimize" class="md-nav__link">
    <span class="md-ellipsis">
      Offline Optimize
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimized-write" class="md-nav__link">
    <span class="md-ellipsis">
      Optimized Write
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#auto-compaction" class="md-nav__link">
    <span class="md-ellipsis">
      Auto Compaction
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimize-vacuum" class="md-nav__link">
    <span class="md-ellipsis">
      Optimize: Vacuum
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#implementation" class="md-nav__link">
    <span class="md-ellipsis">
      Implementation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Implementation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#installing-delta-package" class="md-nav__link">
    <span class="md-ellipsis">
      Installing Delta Package
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-delta-table" class="md-nav__link">
    <span class="md-ellipsis">
      Create delta table
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#read-delta-table" class="md-nav__link">
    <span class="md-ellipsis">
      Read delta table
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#update-delta-table" class="md-nav__link">
    <span class="md-ellipsis">
      Update delta table
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Update delta table">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#overwrite-whole-table" class="md-nav__link">
    <span class="md-ellipsis">
      Overwrite whole table
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#conditional-update" class="md-nav__link">
    <span class="md-ellipsis">
      Conditional Update
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#upsert-delta-table" class="md-nav__link">
    <span class="md-ellipsis">
      Upsert delta table
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delete-delta-table" class="md-nav__link">
    <span class="md-ellipsis">
      Delete delta table
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#time-travel_1" class="md-nav__link">
    <span class="md-ellipsis">
      Time Travel
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#change-data-feed-cdc" class="md-nav__link">
    <span class="md-ellipsis">
      Change Data Feed (CDC)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Change Data Feed (CDC)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#incrementally-process-change-data" class="md-nav__link">
    <span class="md-ellipsis">
      Incrementally process change data
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#quick-code" class="md-nav__link">
    <span class="md-ellipsis">
      Quick Code
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#references" class="md-nav__link">
    <span class="md-ellipsis">
      References
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../spark-hudi/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Apache Hudi and Spark
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../duckdb-quickstart/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    DuckDB Quick Start using Jupyter Notebook
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../data-engineering/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Data Engineering
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3" id="__nav_3_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Data Engineering
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../data-engineering/ingestion/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Ingestion
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../data-engineering/transformation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Transformation
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../data-engineering/visualization/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Visualization
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../data-engineering/storage/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Storage
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../data-engineering/dataops/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    DataOps/Security/Infrastructure
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
          
        
      
        
          
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../data-modeling/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Data Modeling
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4" id="__nav_4_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Data Modeling
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_2" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../data-modeling/dimensional-modeling/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Dimensional Modeling
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4_2" id="__nav_4_2_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_2">
            <span class="md-nav__icon md-icon"></span>
            Dimensional Modeling
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../data-modeling/dimensional-modeling/challenge/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Challenge
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../data-modeling/ddl-vs-dml/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    DDL vs. DML
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../data-modeling/query-lifecycle/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Query Life Cycle
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../data-ingestion/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Data Ingestion
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_5" id="__nav_5_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Data Ingestion
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../data-ingestion/batch/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Batch Ingestion
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../data-ingestion/streaming/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Streaming Ingestion
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../data-ingestion/push-pull/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Push vs. Pull
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_5" >
        
          
          <label class="md-nav__link" for="__nav_5_5" id="__nav_5_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Methods
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_5">
            <span class="md-nav__icon md-icon"></span>
            Methods
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../data-ingestion/methods/sftp/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Secure File Transfer Protocol (SFTP)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../data-ingestion/methods/api/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Application Programming Interface (API)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../data-ingestion/methods/object-storage/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Object Storage
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../data-ingestion/methods/cdc/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Change Data Capture (CDC)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../data-ingestion/methods/streaming-platform/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Streaming Platform
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
          
        
      
        
          
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../data-architecture/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Data Architecture
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_6" id="__nav_6_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Data Architecture
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../data-architecture/framework-architecture/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Framework Architecture
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../data-architecture/storage-architecture/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Storage Architecture
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
          
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_7" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../data-orchestration/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Data Orchestration
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_7" id="__nav_7_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            Data Orchestration
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_7_2" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../data-orchestration/airflow/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Airflow
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_7_2" id="__nav_7_2_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_2">
            <span class="md-nav__icon md-icon"></span>
            Airflow
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../data-orchestration/airflow/airflow-dag-design/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Airflow DAG Design
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../data-orchestration/dbt/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Data Build Tool (dbt)
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_8" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../data-processing/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Data Processing
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_8" id="__nav_8_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            Data Processing
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_8_2" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../data-processing/apache-spark/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Apache Spark
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_8_2" id="__nav_8_2_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_8_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8_2">
            <span class="md-nav__icon md-icon"></span>
            Apache Spark
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../data-processing/apache-spark/spark-optimization/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Spark Optimizations
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_8_3" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../data-processing/bigquery/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Google BigQuery
  </span>
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_8_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8_3">
            <span class="md-nav__icon md-icon"></span>
            Google BigQuery
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
          
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_9" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../data-quality/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Data Quality
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_9" id="__nav_9_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9">
            <span class="md-nav__icon md-icon"></span>
            Data Quality
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../data-quality/dbt-test/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    dbt test
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
          
        
      
        
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_10" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../learning-python/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Python
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_10" id="__nav_10_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10">
            <span class="md-nav__icon md-icon"></span>
            Python
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_10_2" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../learning-python/oop/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Object Oriented Programming
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_10_2" id="__nav_10_2_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_10_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10_2">
            <span class="md-nav__icon md-icon"></span>
            Object Oriented Programming
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../learning-python/oop/class/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Class
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../learning-python/oop/encapsulation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Encapsulation
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../learning-python/oop/inheritance/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Inheritance
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../learning-python/oop/polymorphism/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Polymorphism
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../learning-python/oop/object-relationship/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Object Relationship
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../learning-python/functional-programming/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Functional Programming
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_10_4" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../learning-python/unit-testing/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Unit Testing
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_10_4" id="__nav_10_4_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_10_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10_4">
            <span class="md-nav__icon md-icon"></span>
            Unit Testing
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../learning-python/unit-testing/assertion/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Assertion
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../learning-python/unit-testing/exceptions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Exceptions
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../learning-python/unit-testing/fixtures/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Fixtures
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../learning-python/unit-testing/decorator/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Decorator
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../learning-python/unit-testing/parametrizing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Parametrizing
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../learning-python/unit-testing/mocking/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Mocking
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_10_5" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../learning-python/scaling-python/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Scaling Python
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_10_5" id="__nav_10_5_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_10_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10_5">
            <span class="md-nav__icon md-icon"></span>
            Scaling Python
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../learning-python/scaling-python/cpu-scaling/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CPU Scaling
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../learning-python/scaling-python/async-solution/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Asynchronous Events
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../learning-python/scaling-python/queue-distribution/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Queue-based Distribution
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../author/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    About me
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#what-is-delta-lake" class="md-nav__link">
    <span class="md-ellipsis">
      What is Delta Lake
    </span>
  </a>
  
    <nav class="md-nav" aria-label="What is Delta Lake">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#lakehouse-architecture" class="md-nav__link">
    <span class="md-ellipsis">
      Lakehouse Architecture
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lakehouse-features" class="md-nav__link">
    <span class="md-ellipsis">
      Lakehouse Features
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#contents-of-delta-table" class="md-nav__link">
    <span class="md-ellipsis">
      Contents of Delta table
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Contents of Delta table">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#benefits-for-etl" class="md-nav__link">
    <span class="md-ellipsis">
      Benefits for ETL
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Benefits for ETL">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#query-optimization" class="md-nav__link">
    <span class="md-ellipsis">
      Query Optimization
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reliability" class="md-nav__link">
    <span class="md-ellipsis">
      Reliability
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#schema-enformement-and-evolution" class="md-nav__link">
    <span class="md-ellipsis">
      Schema Enformement and Evolution
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Schema Enformement and Evolution">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#schema-evolution" class="md-nav__link">
    <span class="md-ellipsis">
      Schema Evolution
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#time-travel" class="md-nav__link">
    <span class="md-ellipsis">
      Time Travel
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scalability" class="md-nav__link">
    <span class="md-ellipsis">
      Scalability
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Scalability">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#partitioning" class="md-nav__link">
    <span class="md-ellipsis">
      Partitioning
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#data-clustering" class="md-nav__link">
    <span class="md-ellipsis">
      Data Clustering
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#query-engine-support" class="md-nav__link">
    <span class="md-ellipsis">
      Query Engine Support
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#optimizing-delta-lake" class="md-nav__link">
    <span class="md-ellipsis">
      Optimizing Delta Lake
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Optimizing Delta Lake">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#offline-optimize" class="md-nav__link">
    <span class="md-ellipsis">
      Offline Optimize
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimized-write" class="md-nav__link">
    <span class="md-ellipsis">
      Optimized Write
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#auto-compaction" class="md-nav__link">
    <span class="md-ellipsis">
      Auto Compaction
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimize-vacuum" class="md-nav__link">
    <span class="md-ellipsis">
      Optimize: Vacuum
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#implementation" class="md-nav__link">
    <span class="md-ellipsis">
      Implementation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Implementation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#installing-delta-package" class="md-nav__link">
    <span class="md-ellipsis">
      Installing Delta Package
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-delta-table" class="md-nav__link">
    <span class="md-ellipsis">
      Create delta table
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#read-delta-table" class="md-nav__link">
    <span class="md-ellipsis">
      Read delta table
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#update-delta-table" class="md-nav__link">
    <span class="md-ellipsis">
      Update delta table
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Update delta table">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#overwrite-whole-table" class="md-nav__link">
    <span class="md-ellipsis">
      Overwrite whole table
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#conditional-update" class="md-nav__link">
    <span class="md-ellipsis">
      Conditional Update
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#upsert-delta-table" class="md-nav__link">
    <span class="md-ellipsis">
      Upsert delta table
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delete-delta-table" class="md-nav__link">
    <span class="md-ellipsis">
      Delete delta table
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#time-travel_1" class="md-nav__link">
    <span class="md-ellipsis">
      Time Travel
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#change-data-feed-cdc" class="md-nav__link">
    <span class="md-ellipsis">
      Change Data Feed (CDC)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Change Data Feed (CDC)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#incrementally-process-change-data" class="md-nav__link">
    <span class="md-ellipsis">
      Incrementally process change data
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#quick-code" class="md-nav__link">
    <span class="md-ellipsis">
      Quick Code
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#references" class="md-nav__link">
    <span class="md-ellipsis">
      References
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
    <a href="https://github.com/karlchris/data-engineering/edit/master/docs/projects/delta-spark.md" title="Edit this page" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
    </a>
  
  
    
      
    
    <a href="https://github.com/karlchris/data-engineering/raw/master/docs/projects/delta-spark.md" title="View source of this page" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0 8a5 5 0 0 1-5-5 5 5 0 0 1 5-5 5 5 0 0 1 5 5 5 5 0 0 1-5 5m0-12.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5Z"/></svg>
    </a>
  


<h1 id="delta-lake-with-apache-spark">Delta Lake with Apache Spark<a class="headerlink" href="#delta-lake-with-apache-spark" title="Permanent link">#</a></h1>
<p><img alt="delta-spark" src="../pics/delta-spark.png" /></p>
<p>After years of data management, data warehouses reigned supreme with their structured storage and optimized querying.</p>
<p>However, these warehouses struggled when confronted with the deluge of unstructured and semi-structured data, revealing their limitations.
This void led to the emergence of data lakes, offering a promising solution by accommodating diverse data types without immediate structure.</p>
<p>Yet, the initial euphoria surrounding data lakes gave way to challenges of <strong>maintaining data integrity</strong>, <strong>ensuring consistency</strong>, and <strong>handling updates and deletions effectively</strong>.</p>
<div class="admonition success">
<p class="admonition-title">Success</p>
<p>Enter <strong>Delta Lake</strong>, a technological evolution that seeks to address the shortcomings of traditional data warehouses and data lakes alike.</p>
</div>
<h2 id="what-is-delta-lake">What is Delta Lake<a class="headerlink" href="#what-is-delta-lake" title="Permanent link">#</a></h2>
<p><strong>Delta Lake</strong> is an open-source table format for data storage.
Delta Lake improves data storage by supporting ACID transactions, high-performance query optimizations, schema enforcement and evolution, data versioning and many other features.</p>
<p>A Delta table consists of 2 main components:</p>
<ul>
<li><strong>Parquet files</strong> that contain the data, and</li>
<li>a <strong>transaction log</strong> that stores metadata about the transactions</li>
</ul>
<h3 id="lakehouse-architecture">Lakehouse Architecture<a class="headerlink" href="#lakehouse-architecture" title="Permanent link">#</a></h3>
<p>A <strong>lakehouse</strong> is a new, open architecture that combines the best elements of <strong>data lakes</strong> and <strong>data warehouses</strong>.</p>
<p>Lakehouses are enabled by a new system design: implementing similar data structures and data management features to those in a data warehouse directly on top of low cost cloud storage in open formats.</p>
<p><img alt="lakehouse-architecture" src="../pics/lakehouse-architecture.png" /></p>
<h3 id="lakehouse-features">Lakehouse Features<a class="headerlink" href="#lakehouse-features" title="Permanent link">#</a></h3>
<ul>
<li><strong>Transaction support</strong>: many data pipelines will often be reading and writing data concurrently.</li>
<li><strong>Schema enforcement and governance</strong>: The Lakehouse should have a way to support the schema enforcement and evolution, supporting DW schema such as star/snowflake-schemas.</li>
<li><strong>BI support</strong>: Lakehouses enable using BI tools directly on the source data.</li>
<li><strong>Storage is decoupled from compute</strong>: In practice, this means storage and compute use separate clusters, thus these systems are able to scale to many more concurrent users and larger data sizes.</li>
<li><strong>Openness</strong>: The storage format they use are open and standardized, such as Parquet, and they provide an API so a variety of tools/engines can efficiently access the data.</li>
<li><strong>Support for diverse data types ranging from unstructured and structured data</strong></li>
<li><strong>Support for diverse workloads</strong>: including data science, machine learning, and SQL and analytics.</li>
<li><strong>End-to-end streaming</strong>: Real-time reports are the norm in many enterprises. Support for streaming eliminates the need for separate systems dedicated to serving real-time data applications.</li>
</ul>
<h2 id="contents-of-delta-table">Contents of Delta table<a class="headerlink" href="#contents-of-delta-table" title="Permanent link">#</a></h2>
<p><img alt="contents-of-delta-table" src="../pics/contents-of-delta-table.png" /></p>
<p>The transaction log enables Delta Lake to optimize the queries, ensure reliable reads and writes, and to store a record of all data transformations.</p>
<p>Delta Lake supports both ETL and ELT workloads.</p>
<h3 id="benefits-for-etl">Benefits for ETL<a class="headerlink" href="#benefits-for-etl" title="Permanent link">#</a></h3>
<p>Delta Lake is great for <strong>ETL</strong> because of its performance and reliability.</p>
<p>Here are some features that will improve ETL workloads:</p>
<h4 id="query-optimization">Query Optimization<a class="headerlink" href="#query-optimization" title="Permanent link">#</a></h4>
<p>Delta Lake makes data transformations faster by:</p>
<ul>
<li>storing file paths and metadata in the transaction log</li>
<li>executing partial reads via file-skipping</li>
<li>co-locating similar data to allow for better file skipping</li>
</ul>
<div class="admonition tips">
<p class="admonition-title">Tips</p>
<p><strong>Transaction logs</strong></p>
<p>Delta Lake stores all file paths, metadata and data transformation operations in a dedicated transaction log. This makes file listing faster and enables partial data reads.</p>
<p><strong>File-skipping</strong></p>
<p>Delta Lake stores metadata at the file-level in a single transaction log. This way query engines can figure out which data can be skipped using a single network request. Entire files can be skipped this way.</p>
<p><strong>Co-locating similar data</strong></p>
<p>Delta Lake can store similar data close together to improve your query performance, using Z-Ordering or Liquid Clustering.</p>
</div>
<h4 id="reliability">Reliability<a class="headerlink" href="#reliability" title="Permanent link">#</a></h4>
<p>Delta Lake makes your ETL workloads more reliable by enforcing ACID transactions. Transactions prevent your data from being corrupted or lost.</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Data storage formats without transaction support (like CSV or Parquet) can easily be corrupted. </p>
<p>For example, if you're writing a large amount of data and your cluster dies then you'll have several partially written files in your table. These partial files will cause downstream read operations to crash.</p>
</div>
<p>Delta Lake transactions give you 4 important guarantess:</p>
<ul>
<li><strong>No more failed partial writes</strong>: Every write operation either completes entirely or else it fails entirely and no data gets changed.</li>
<li><strong>No more corrupted tables</strong>: If a transaction is going to break any of the pre-defined constraints, the entire transaction is rejected and will not complete.</li>
<li><strong>No more conflicting data versions</strong>: Concurrent processes happen in isolation from each other and cannot access each other's intermediate states.</li>
<li><strong>No more unintended data loss</strong>: All data changes are guaranteed to never be lost, even in the events of system failures or power outages.</li>
</ul>
<h4 id="schema-enformement-and-evolution">Schema Enformement and Evolution<a class="headerlink" href="#schema-enformement-and-evolution" title="Permanent link">#</a></h4>
<p>To prevent accidental data corruption, Delta Lake provides schema enforcement.</p>
<p>You cannot write new data to a Delta table if it doesn't match the existing table's schema. It will error out with an <code>AnalysisException</code>.</p>
<p>For example, let's create a Delta table with a simple schema:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">createDataFrame</span><span class="p">([(</span><span class="s2">&quot;bob&quot;</span><span class="p">,</span> <span class="mi">47</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;li&quot;</span><span class="p">,</span> <span class="mi">23</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;leonard&quot;</span><span class="p">,</span> <span class="mi">51</span><span class="p">)])</span><span class="o">.</span><span class="n">toDF</span><span class="p">(</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="s2">&quot;first_name&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="p">)</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="n">df</span><span class="o">.</span><span class="n">write</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;delta&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;data/toy_data&quot;</span><span class="p">)</span>
</span></code></pre></div>
<p>Now, let's try to write data with a different schema to this same Delta table:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">createDataFrame</span><span class="p">([(</span><span class="s2">&quot;frank&quot;</span><span class="p">,</span> <span class="mi">68</span><span class="p">,</span> <span class="s2">&quot;usa&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;jordana&quot;</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="s2">&quot;brasil&quot;</span><span class="p">)])</span><span class="o">.</span><span class="n">toDF</span><span class="p">(</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>    <span class="s2">&quot;first_name&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span><span class="p">,</span> <span class="s2">&quot;country&quot;</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="p">)</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="n">df</span><span class="o">.</span><span class="n">write</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;delta&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mode</span><span class="p">(</span><span class="s2">&quot;append&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;data/toy_data&quot;</span><span class="p">)</span>
</span></code></pre></div>
<p>Here's the complete error:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>AnalysisException:<span class="w"> </span><span class="o">[</span>_LEGACY_ERROR_TEMP_DELTA_0007<span class="o">]</span><span class="w"> </span>A<span class="w"> </span>schema<span class="w"> </span>mismatch<span class="w"> </span>detected<span class="w"> </span>when<span class="w"> </span>writing<span class="w"> </span>to<span class="w"> </span>the<span class="w"> </span>Delta<span class="w"> </span>table
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>Table<span class="w"> </span>schema:
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>root
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>--<span class="w"> </span>first_name:<span class="w"> </span>string<span class="w"> </span><span class="o">(</span><span class="nv">nullable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="o">)</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a>--<span class="w"> </span>age:<span class="w"> </span>long<span class="w"> </span><span class="o">(</span><span class="nv">nullable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="o">)</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a>Data<span class="w"> </span>schema:
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a>root
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a>--<span class="w"> </span>first_name:<span class="w"> </span>string<span class="w"> </span><span class="o">(</span><span class="nv">nullable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="o">)</span>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a>--<span class="w"> </span>age:<span class="w"> </span>long<span class="w"> </span><span class="o">(</span><span class="nv">nullable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="o">)</span>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a>--<span class="w"> </span>country:<span class="w"> </span>string<span class="w"> </span><span class="o">(</span><span class="nv">nullable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="o">)</span>
</span></code></pre></div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Delta Lake does not allow you to append data with mismatched schema by default.</p>
</div>
<h5 id="schema-evolution">Schema Evolution<a class="headerlink" href="#schema-evolution" title="Permanent link">#</a></h5>
<p>Of course, ETL workloads evolve over time. Input data may change or your downstream analysis might need a new column. When you need more flexibility in your schema, Delta Lake also supports Schema Evolution.</p>
<p>To update the schema of your Delta table, you can write data with the <code>mergeSchema</code> option. Let's try this for the example that we just saw above:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="n">df</span><span class="o">.</span><span class="n">write</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;mergeSchema&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mode</span><span class="p">(</span><span class="s2">&quot;append&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;delta&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">(</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>    <span class="s2">&quot;data/toy_data&quot;</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="p">)</span>
</span></code></pre></div>
<p>Here are the contents of your Delta table after the write:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>spark.read.format<span class="o">(</span><span class="s2">&quot;delta&quot;</span><span class="o">)</span>.load<span class="o">(</span><span class="s2">&quot;data/toy_data&quot;</span><span class="o">)</span>.show<span class="o">()</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>+----------+---+-------+
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="p">|</span>first_name<span class="p">|</span>age<span class="p">|</span>country<span class="p">|</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a>+----------+---+-------+
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="p">|</span><span class="w">   </span>jordana<span class="p">|</span><span class="w"> </span><span class="m">26</span><span class="p">|</span><span class="w"> </span>brasil<span class="p">|</span><span class="w"> </span><span class="c1"># new</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a><span class="p">|</span><span class="w">     </span>frank<span class="p">|</span><span class="w"> </span><span class="m">68</span><span class="p">|</span><span class="w">    </span>usa<span class="p">|</span><span class="w"> </span><span class="c1"># new</span>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a><span class="p">|</span><span class="w">   </span>leonard<span class="p">|</span><span class="w"> </span><span class="m">51</span><span class="p">|</span><span class="w">   </span>null<span class="p">|</span>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a><span class="p">|</span><span class="w">       </span>bob<span class="p">|</span><span class="w"> </span><span class="m">47</span><span class="p">|</span><span class="w">   </span>null<span class="p">|</span>
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a><span class="p">|</span><span class="w">        </span>li<span class="p">|</span><span class="w"> </span><span class="m">23</span><span class="p">|</span><span class="w">   </span>null<span class="p">|</span>
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a>+----------+---+-------+
</span></code></pre></div>
<p>The Delta table now has three columns. It previously only had two columns. Rows that don't have any data for the new column will be marked as null when new columns are added.</p>
<h4 id="time-travel">Time Travel<a class="headerlink" href="#time-travel" title="Permanent link">#</a></h4>
<p>Nobody is perfect. And no ETL pipeline is perfect, either.</p>
<p>When mistakes happen, you want to be able to roll back your data to a previous version before the mistake. Doing this manually is painful and takes a lot of time. Delta Lake makes this easy by supporting time travel functionality.</p>
<p>Because all of the transactions are stored in the <strong>transaction log</strong>, Delta Lake can always travel back to earlier states of your table.</p>
<h4 id="scalability">Scalability<a class="headerlink" href="#scalability" title="Permanent link">#</a></h4>
<p>ETL workloads often scale up as more data becomes available.
Delta Lake supports both small and very large data workloads.</p>
<p>Delta Lake makes it easier and faster to process large workloads by:</p>
<h5 id="partitioning">Partitioning<a class="headerlink" href="#partitioning" title="Permanent link">#</a></h5>
<p><img alt="delta-lake-partitioning" src="../pics/delta-lake-partitioning.png" /></p>
<p>File partitioning makes it faster to work with data at scale.</p>
<p>In the Query Optimization example we saw above, we used a smart partitioning strategy to make our query run faster. When you partition a table on a certain column, Delta Lake stores all records with the same column value in the same file. This way it can skip entire files when certain column values are not needed.</p>
<p>Partitioning is especially efficient with parallel query engines. In this case, each process (or worker) can read its own partitions in parallel. This speeds up your queries and lets you process more data in less time.</p>
<h5 id="data-clustering">Data Clustering<a class="headerlink" href="#data-clustering" title="Permanent link">#</a></h5>
<p>Delta Lake lets you store similar data close together via <strong>Liquid Clustering</strong>, <strong>Z-ordering</strong> and <strong>Hive-style partitioning</strong>. Liquid Clustering is the newest and most performant technique of the three.</p>
<p>Your ETL workload will likely benefit from clustering if:</p>
<ul>
<li>You often need to filter by high cardinality columns.</li>
<li>Your data has significant skew in data distribution.</li>
<li>Your tables grow quickly and require maintenance and tuning effort.</li>
<li>Your data access patterns change over time.</li>
</ul>
<h5 id="query-engine-support">Query Engine Support<a class="headerlink" href="#query-engine-support" title="Permanent link">#</a></h5>
<p>Delta Lake makes it easy to work with lots of different query engines.</p>
<p>You might start working locally with a single-node processing library like polars:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="c1"># load data</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="n">df</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="c1"># perform some data operations</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="o">...</span>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a><span class="c1"># write to delta table</span>
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a><span class="n">df</span><span class="o">.</span><span class="n">write_delta</span><span class="p">(</span><span class="s2">&quot;data/delta_table&quot;</span><span class="p">)</span>
</span></code></pre></div>
<p>When your data volume increases, you can switch to a distributed query engine like Spark:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="c1"># load delta table created with polars</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;delta&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;data/delta_table&quot;</span><span class="p">)</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="c1"># join to much larger dataset</span>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="n">big_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">new_df</span><span class="p">,</span> <span class="err"></span><span class="p">)</span>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a>
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a><span class="c1"># run big data operations</span>
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a><span class="err"></span>
</span><span id="__span-6-9"><a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a>
</span><span id="__span-6-10"><a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a><span class="c1"># write to delta table</span>
</span><span id="__span-6-11"><a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a><span class="n">big_df</span><span class="o">.</span><span class="n">write</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;delta&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mode</span><span class="p">(</span><span class="s2">&quot;append&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;overwriteSchema&quot;</span><span class="p">,</span> <span class="s2">&quot;True&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;data/delta_table&quot;</span><span class="p">)</span>
</span></code></pre></div>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>Delta Lake has great interoperability with many query engines.</p>
</div>
<h2 id="optimizing-delta-lake">Optimizing Delta Lake<a class="headerlink" href="#optimizing-delta-lake" title="Permanent link">#</a></h2>
<p>How to optimize your Delta Lake table to reduce the number of small files.</p>
<p>Small files can be a problem because they slow down your query reads. Listing, opening and closing many small files incurs expensive overhead. This is called <strong>"the Small File Problem"</strong>. You can reduce the Small File Problem overhead by combining the data into bigger, more efficient files.</p>
<p>The code below runs a query on a Delta table with 2 million rows. The Delta table is partitioned on the <code>education</code> column and has 1440 files per partition:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="o">%%</span><span class="n">time</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;delta&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;test/delta_table_1440&quot;</span><span class="p">)</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="n">res</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">education</span> <span class="o">==</span> <span class="s2">&quot;10th&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="n">CPU</span> <span class="n">times</span><span class="p">:</span> <span class="n">user</span> <span class="mi">175</span> <span class="n">ms</span><span class="p">,</span> <span class="n">sys</span><span class="p">:</span> <span class="mf">20.1</span> <span class="n">ms</span><span class="p">,</span> <span class="n">total</span><span class="p">:</span> <span class="mi">195</span> <span class="n">ms</span>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="n">Wall</span> <span class="n">time</span><span class="p">:</span> <span class="mf">16.1</span> <span class="n">s</span>
</span></code></pre></div>
<p>Now compare this to the same query on the same 2M-rows of data stored in a Delta table with only 1 optimized file per partition:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="o">%%</span><span class="n">time</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;delta&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;test/delta_table_1&quot;</span><span class="p">)</span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="n">res</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">education</span> <span class="o">==</span> <span class="s2">&quot;10th&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span class="n">CPU</span> <span class="n">times</span><span class="p">:</span> <span class="n">user</span> <span class="mi">156</span> <span class="n">ms</span><span class="p">,</span> <span class="n">sys</span><span class="p">:</span> <span class="mi">16</span> <span class="n">ms</span><span class="p">,</span> <span class="n">total</span><span class="p">:</span> <span class="mi">172</span> <span class="n">ms</span>
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a><span class="n">Wall</span> <span class="n">time</span><span class="p">:</span> <span class="mf">4.62</span> <span class="n">s</span>
</span></code></pre></div>
<p>Storing data in an optimized number of files will improve your out-of-the-box read performance.</p>
<p>There are 3 ways you can optimize your Delta Lake table:</p>
<h3 id="offline-optimize">Offline Optimize<a class="headerlink" href="#offline-optimize" title="Permanent link">#</a></h3>
<p>Suppose you have an ETL pipeline that ingests some data every day. The data is streamed into a partitioned Delta table that gets updated every minute.</p>
<p>This means you will end up with 1440 files per partition at the end of every day.</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a>&gt;<span class="w"> </span><span class="c1"># get n files per partition</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>&gt;<span class="w"> </span>!ls<span class="w"> </span>test/delta_table/education<span class="se">\=</span>10th/*.parquet<span class="w"> </span><span class="p">|</span><span class="w"> </span>wc<span class="w"> </span>-l
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="m">1440</span>
</span></code></pre></div>
<p>Running a query on a Delta table with many small files is not efficient, as we saw above.</p>
<p>You can manually run the Delta OPTIMIZE command to optimize the number of files. This is done by compacting all the inefficient small files into larger files that are more efficient to read. The default file size written in each partition after this operation is 1 GB.</p>
<p>You can perform a compaction manually using:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="kn">from</span> <span class="nn">delta.tables</span> <span class="kn">import</span> <span class="o">*</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="n">deltaTable</span> <span class="o">=</span> <span class="n">DeltaTable</span><span class="o">.</span><span class="n">forPath</span><span class="p">(</span><span class="n">spark</span><span class="p">,</span> <span class="s2">&quot;test/delta_table&quot;</span><span class="p">)</span>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="n">deltaTable</span><span class="o">.</span><span class="n">optimize</span><span class="p">()</span><span class="o">.</span><span class="n">executeCompaction</span><span class="p">()</span>
</span></code></pre></div>
<p>Downstream queries on this optimized Delta table will now be faster.</p>
<h3 id="optimized-write">Optimized Write<a class="headerlink" href="#optimized-write" title="Permanent link">#</a></h3>
<p>You dont have to manually run the OPTIMIZE command. You can also configure optimizations to run automatically on your Delta Table.</p>
<p><img alt="delta-table-optimized-writes" src="../pics/delta-table-optimized-writes.png" /></p>
<p><strong>Optimized Write</strong> combines all the small writes to the same partition into a single write command before executing.
This is great when multiple processes are writing to the same partitioned Delta table, i.e. a distributed write operation.</p>
<p>Optimized Write rebalances the data using a data shuffle before writing the files to the table. This way you will reduce the number of small files.</p>
<p>You can enable Optimized Write by setting the optimizeWrite option in your Delta Lake writer:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="n">df</span><span class="o">.</span><span class="n">write</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;delta&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;optimizeWrite&quot;</span><span class="p">,</span> <span class="s2">&quot;True&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;path/to/delta&quot;</span><span class="p">)</span>
</span></code></pre></div>
<p>You can also enable the Optimized Write functionality:</p>
<ul>
<li>for your whole Delta table by setting the <code>delta.autoOptimize.optimizeWrite</code> table property.</li>
<li>for your whole Spark SQL session by setting the <code>spark.databricks.delta.optimizeWrite.enabled</code> SQL configuration</li>
</ul>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Optimized Writes take a bit longer to execute because of the data shuffle that is performed before the data gets written.
Thats why the feature is not enabled by default.</p>
</div>
<h3 id="auto-compaction">Auto Compaction<a class="headerlink" href="#auto-compaction" title="Permanent link">#</a></h3>
<p>Optimized Write is great for distributed write situations with many different processes writing to the same Delta table.</p>
<p>But sometimes that is not enough to solve the Small File Problem, for example when you are writing frequent small updates to a table. In this case, the files will still be small, even after an Optimized Write.</p>
<p><strong>Auto Compaction</strong> solves this problem by automatically running a small <code>optimize</code> command after every write operation. Data from files under a certain threshold size is automatically combined into a larger file. This way, your downstream queries can benefit from a more optimal file size.</p>
<p>You can enable Auto Compaction for your Delta table or your entire Spark session:</p>
<ul>
<li>Table property: <code>delta.autoOptimize.autoCompact</code></li>
<li>SparkSession setting: <code>spark.databricks.delta.autoCompact.enabled</code></li>
</ul>
<p>Auto Compaction is only triggered for partitions or tables that have at least a certain number of small files. The minimum number of files required to trigger auto compaction can be configured with <code>spark.databricks.delta.autoCompact</code>.minNumFiles.</p>
<h3 id="optimize-vacuum">Optimize: Vacuum<a class="headerlink" href="#optimize-vacuum" title="Permanent link">#</a></h3>
<p>Because Auto Compaction optimizes your Delta Table <em>after</em> the write operations, you may still have many small files on disk.</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a>&gt;<span class="w"> </span><span class="c1"># get n files per partition</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a>&gt;<span class="w"> </span>!ls<span class="w"> </span>delta/census_table_compact/education<span class="se">\=</span>10th/*.parquet<span class="w"> </span><span class="p">|</span><span class="w"> </span>wc<span class="w"> </span>-l
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="m">1441</span>
</span></code></pre></div>
<p>In this case we have 1440 files (one per partition) and 1 final file that contains all the data.</p>
<p>Delta Lake has iteratively combined all the small writes into a larger file. It has also recorded in the transaction log the path to the latest file. Downstream data reads will look at the transaction log and access only the last, largest file.</p>
<p>But as you can see the older, smaller files are still on disk. This doesnt affect your read performance because Delta Lake knows that you only need to access the latest file. But you might still want to remove these files, for example to save on storage costs.</p>
<p>You can remove these older files with a <code>VACUUM</code> command. The parameter is the number of preceding hours you want to preserve.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="n">deltaTable</span><span class="o">.</span><span class="n">vacuum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></code></pre></div>
<p>The <code>VACUUM</code> command removes old files that are no longer actively referenced in the transaction log. By default, <code>VACUUM</code> only affects files older than the default retention duration which is <strong>7 days</strong>.</p>
<p>You can override this default setting using:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s2">&quot;SET spark.databricks.delta.retentionDurationCheck.enabled=false&quot;</span><span class="p">)</span>
</span></code></pre></div>
<h2 id="implementation">Implementation<a class="headerlink" href="#implementation" title="Permanent link">#</a></h2>
<p>Here we go to start the implementation of how delta table is being executed and let's get a quick look on delta CDC operations.</p>
<p>First of all, you need to clone this repo</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a>git<span class="w"> </span>clone<span class="w"> </span>git@github.com:karlchris/spark-docker.git
</span></code></pre></div>
<h3 id="installing-delta-package">Installing Delta Package<a class="headerlink" href="#installing-delta-package" title="Permanent link">#</a></h3>
<p>You need to install some delta jars into Dockerfile</p>
<div class="language-Dockerfile highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="c"># Download delta jars</span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="k">RUN</span><span class="w"> </span>curl<span class="w"> </span>https://repo1.maven.org/maven2/io/delta/delta-core_2.12/2.4.0/delta-core_2.12-2.4.0.jar<span class="w"> </span>-Lo<span class="w"> </span>/opt/spark/jars/delta-core_2.12-2.4.0.jar
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="k">RUN</span><span class="w"> </span>curl<span class="w"> </span>https://repo1.maven.org/maven2/io/delta/delta-spark_2.12/3.2.0/delta-spark_2.12-3.2.0.jar<span class="w"> </span>-Lo<span class="w"> </span>/opt/spark/jars/delta-spark_2.12-3.2.0.jar
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="k">RUN</span><span class="w"> </span>curl<span class="w"> </span>https://repo1.maven.org/maven2/io/delta/delta-storage/3.2.0/delta-storage-3.2.0.jar<span class="w"> </span>-Lo<span class="w"> </span>/opt/spark/jars/delta-storage-3.2.0.jar
</span></code></pre></div>
<p>In the python script itself, you need to set the configurations.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span>
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a><span class="kn">from</span> <span class="nn">pyspark</span> <span class="kn">import</span> <span class="n">SparkConf</span>
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a><span class="kn">from</span> <span class="nn">pyspark.sql.types</span> <span class="kn">import</span> <span class="n">StructType</span><span class="p">,</span> <span class="n">StructField</span><span class="p">,</span> <span class="n">StringType</span><span class="p">,</span> <span class="n">IntegerType</span>
</span><span id="__span-17-4"><a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a><span class="kn">from</span> <span class="nn">delta</span> <span class="kn">import</span> <span class="o">*</span>
</span><span id="__span-17-5"><a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a><span class="kn">from</span> <span class="nn">delta.tables</span> <span class="kn">import</span> <span class="o">*</span>
</span><span id="__span-17-6"><a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a><span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">expr</span><span class="p">,</span> <span class="n">lit</span><span class="p">,</span> <span class="n">col</span>
</span><span id="__span-17-7"><a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a>
</span><span id="__span-17-8"><a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a><span class="n">jars</span> <span class="o">=</span> <span class="s1">&#39;io.delta:delta-spark_2.12:3.2.0,io.delta:delta-core_2.12:2.4.0,io.delta:delta-storage:3.2.0&#39;</span>
</span><span id="__span-17-9"><a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a>
</span><span id="__span-17-10"><a id="__codelineno-17-10" name="__codelineno-17-10" href="#__codelineno-17-10"></a><span class="c1"># Setup config</span>
</span><span id="__span-17-11"><a id="__codelineno-17-11" name="__codelineno-17-11" href="#__codelineno-17-11"></a><span class="n">conf</span> <span class="o">=</span> <span class="n">SparkConf</span><span class="p">()</span><span class="o">.</span><span class="n">setAppName</span><span class="p">(</span><span class="s2">&quot;deltaDemo&quot;</span><span class="p">)</span> \
</span><span id="__span-17-12"><a id="__codelineno-17-12" name="__codelineno-17-12" href="#__codelineno-17-12"></a>    <span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;spark.sql.extensions&quot;</span><span class="p">,</span> <span class="s2">&quot;io.delta.sql.DeltaSparkSessionExtension&quot;</span><span class="p">)</span> \
</span><span id="__span-17-13"><a id="__codelineno-17-13" name="__codelineno-17-13" href="#__codelineno-17-13"></a>    <span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;spark.sql.catalog.spark_catalog&quot;</span><span class="p">,</span> <span class="s2">&quot;org.apache.spark.sql.delta.catalog.DeltaCatalog&quot;</span><span class="p">)</span> \
</span><span id="__span-17-14"><a id="__codelineno-17-14" name="__codelineno-17-14" href="#__codelineno-17-14"></a>    <span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;spark.jars.packages&#39;</span><span class="p">,</span> <span class="n">jars</span><span class="p">)</span>
</span><span id="__span-17-15"><a id="__codelineno-17-15" name="__codelineno-17-15" href="#__codelineno-17-15"></a>
</span><span id="__span-17-16"><a id="__codelineno-17-16" name="__codelineno-17-16" href="#__codelineno-17-16"></a><span class="c1"># Create spark session</span>
</span><span id="__span-17-17"><a id="__codelineno-17-17" name="__codelineno-17-17" href="#__codelineno-17-17"></a><span class="n">spark</span> <span class="o">=</span> <span class="n">SparkSession</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">conf</span><span class="o">=</span><span class="n">conf</span><span class="p">)</span><span class="o">.</span><span class="n">getOrCreate</span><span class="p">()</span>
</span><span id="__span-17-18"><a id="__codelineno-17-18" name="__codelineno-17-18" href="#__codelineno-17-18"></a><span class="n">spark</span><span class="o">.</span><span class="n">sparkContext</span><span class="o">.</span><span class="n">setLogLevel</span><span class="p">(</span><span class="s2">&quot;ERROR&quot;</span><span class="p">)</span>
</span></code></pre></div>
<ul>
<li>You will need to build the docker compose, by running below command:</li>
</ul>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a>make<span class="w"> </span>up
</span></code></pre></div>
<p>Output:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="o">(</span>base<span class="o">)</span><span class="w"> </span><span class="w">  </span>spark-docker<span class="w"> </span>git:<span class="o">(</span>main<span class="o">)</span><span class="w"> </span><span class="w"> </span>make<span class="w"> </span>up<span class="w"> </span>
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a>docker<span class="w"> </span>compose<span class="w"> </span>up<span class="w"> </span>-d<span class="w"> </span>--build
</span><span id="__span-19-3"><a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a><span class="o">[</span>+<span class="o">]</span><span class="w"> </span>Building<span class="w"> </span><span class="m">2</span>.7s<span class="w"> </span><span class="o">(</span><span class="m">21</span>/21<span class="o">)</span><span class="w"> </span>FINISHED<span class="w">                                                                                                                                                                                                                                                                 </span>docker:desktop-linux
</span><span id="__span-19-4"><a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a><span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span><span class="o">[</span>spark-master<span class="w"> </span>internal<span class="o">]</span><span class="w"> </span>load<span class="w"> </span>build<span class="w"> </span>definition<span class="w"> </span>from<span class="w"> </span>Dockerfile<span class="w">                                                                                                                                                                                                                                                  </span><span class="m">0</span>.0s
</span><span id="__span-19-5"><a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a><span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span>transferring<span class="w"> </span>dockerfile:<span class="w"> </span><span class="m">2</span>.38kB<span class="w">                                                                                                                                                                                                                                                                             </span><span class="m">0</span>.0s
</span><span id="__span-19-6"><a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a><span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span><span class="o">[</span>spark-master<span class="w"> </span>internal<span class="o">]</span><span class="w"> </span>load<span class="w"> </span>metadata<span class="w"> </span><span class="k">for</span><span class="w"> </span>docker.io/library/python:3.10-bullseye<span class="w">                                                                                                                                                                                                                               </span><span class="m">2</span>.5s
</span><span id="__span-19-7"><a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a><span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span><span class="o">[</span>spark-master<span class="w"> </span>auth<span class="o">]</span><span class="w"> </span>library/python:pull<span class="w"> </span>token<span class="w"> </span><span class="k">for</span><span class="w"> </span>registry-1.docker.io<span class="w">                                                                                                                                                                                                                                         </span><span class="m">0</span>.0s
</span><span id="__span-19-8"><a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a><span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span><span class="o">[</span>spark-master<span class="w"> </span>internal<span class="o">]</span><span class="w"> </span>load<span class="w"> </span>.dockerignore<span class="w">                                                                                                                                                                                                                                                                     </span><span class="m">0</span>.0s
</span><span id="__span-19-9"><a id="__codelineno-19-9" name="__codelineno-19-9" href="#__codelineno-19-9"></a><span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span>transferring<span class="w"> </span>context:<span class="w"> </span>2B<span class="w">                                                                                                                                                                                                                                                                                    </span><span class="m">0</span>.0s
</span><span id="__span-19-10"><a id="__codelineno-19-10" name="__codelineno-19-10" href="#__codelineno-19-10"></a><span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span><span class="o">[</span>spark-master<span class="w"> </span>spark-base<span class="w"> </span><span class="m">1</span>/5<span class="o">]</span><span class="w"> </span>FROM<span class="w"> </span>docker.io/library/python:3.10-bullseye@sha256:a894d9de36c807c43b543bce5e52702b8b22de985ca087f3478a4a4b18c86d37<span class="w">                                                                                                                                                              </span><span class="m">0</span>.0s
</span><span id="__span-19-11"><a id="__codelineno-19-11" name="__codelineno-19-11" href="#__codelineno-19-11"></a><span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span>resolve<span class="w"> </span>docker.io/library/python:3.10-bullseye@sha256:a894d9de36c807c43b543bce5e52702b8b22de985ca087f3478a4a4b18c86d37<span class="w">                                                                                                                                                                                      </span><span class="m">0</span>.0s
</span><span id="__span-19-12"><a id="__codelineno-19-12" name="__codelineno-19-12" href="#__codelineno-19-12"></a><span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span><span class="o">[</span>spark-master<span class="w"> </span>internal<span class="o">]</span><span class="w"> </span>load<span class="w"> </span>build<span class="w"> </span>context<span class="w">                                                                                                                                                                                                                                                                     </span><span class="m">0</span>.0s
</span><span id="__span-19-13"><a id="__codelineno-19-13" name="__codelineno-19-13" href="#__codelineno-19-13"></a><span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span>transferring<span class="w"> </span>context:<span class="w"> </span><span class="m">1</span>.00kB<span class="w">                                                                                                                                                                                                                                                                                </span><span class="m">0</span>.0s
</span><span id="__span-19-14"><a id="__codelineno-19-14" name="__codelineno-19-14" href="#__codelineno-19-14"></a><span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span>CACHED<span class="w"> </span><span class="o">[</span>spark-master<span class="w"> </span>spark-base<span class="w"> </span><span class="m">2</span>/5<span class="o">]</span><span class="w"> </span>RUN<span class="w"> </span>apt-get<span class="w"> </span>update<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w">     </span>apt-get<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>--no-install-recommends<span class="w">       </span>sudo<span class="w">       </span>curl<span class="w">       </span>vim<span class="w">       </span>unzip<span class="w">       </span>rsync<span class="w">       </span>openjdk-11-jdk<span class="w">       </span>build-essential<span class="w">       </span>software-properties-common<span class="w">       </span>ssh<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w">     </span>apt-get<span class="w"> </span>clean<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w">     </span>rm<span class="w"> </span>-rf<span class="w"> </span>/var/lib/apt/lists<span class="w">  </span><span class="m">0</span>.0s
</span><span id="__span-19-15"><a id="__codelineno-19-15" name="__codelineno-19-15" href="#__codelineno-19-15"></a><span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span>CACHED<span class="w"> </span><span class="o">[</span>spark-master<span class="w"> </span>spark-base<span class="w"> </span><span class="m">3</span>/5<span class="o">]</span><span class="w"> </span>RUN<span class="w"> </span>mkdir<span class="w"> </span>-p<span class="w"> </span>/opt/hadoop<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>mkdir<span class="w"> </span>-p<span class="w"> </span>/opt/spark<span class="w">                                                                                                                                                                                                                           </span><span class="m">0</span>.0s
</span><span id="__span-19-16"><a id="__codelineno-19-16" name="__codelineno-19-16" href="#__codelineno-19-16"></a><span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span>CACHED<span class="w"> </span><span class="o">[</span>spark-master<span class="w"> </span>spark-base<span class="w"> </span><span class="m">4</span>/5<span class="o">]</span><span class="w"> </span>WORKDIR<span class="w"> </span>/opt/spark<span class="w">                                                                                                                                                                                                                                                        </span><span class="m">0</span>.0s
</span><span id="__span-19-17"><a id="__codelineno-19-17" name="__codelineno-19-17" href="#__codelineno-19-17"></a><span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span>CACHED<span class="w"> </span><span class="o">[</span>spark-master<span class="w"> </span>spark-base<span class="w"> </span><span class="m">5</span>/5<span class="o">]</span><span class="w"> </span>RUN<span class="w"> </span>mkdir<span class="w"> </span>-p<span class="w"> </span>/opt/spark<span class="w">     </span><span class="o">&amp;&amp;</span><span class="w"> </span>curl<span class="w"> </span>https://dlcdn.apache.org/spark/spark-3.5.1/spark-3.5.1-bin-hadoop3.tgz<span class="w"> </span>-o<span class="w"> </span>spark-3.5.1-bin-hadoop3.tgz<span class="w">     </span><span class="o">&amp;&amp;</span><span class="w"> </span>tar<span class="w"> </span>xvzf<span class="w"> </span>spark-3.5.1-bin-hadoop3.tgz<span class="w"> </span>--directory<span class="w"> </span>/opt/spark<span class="w"> </span>--strip-components<span class="w"> </span><span class="m">1</span><span class="w">     </span><span class="o">&amp;&amp;</span><span class="w"> </span>rm<span class="w"> </span>-rf<span class="w"> </span>spark-3.5.1-bin-hadoop3.<span class="w">  </span><span class="m">0</span>.0s
</span><span id="__span-19-18"><a id="__codelineno-19-18" name="__codelineno-19-18" href="#__codelineno-19-18"></a><span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span>CACHED<span class="w"> </span><span class="o">[</span>spark-master<span class="w"> </span>pyspark<span class="w"> </span><span class="m">1</span>/4<span class="o">]</span><span class="w"> </span>COPY<span class="w"> </span>requirements.txt<span class="w"> </span>.<span class="w">                                                                                                                                                                                                                                                      </span><span class="m">0</span>.0s
</span><span id="__span-19-19"><a id="__codelineno-19-19" name="__codelineno-19-19" href="#__codelineno-19-19"></a><span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span>CACHED<span class="w"> </span><span class="o">[</span>spark-master<span class="w"> </span>pyspark<span class="w"> </span><span class="m">2</span>/4<span class="o">]</span><span class="w"> </span>RUN<span class="w"> </span>pip3<span class="w"> </span>install<span class="w"> </span>-r<span class="w"> </span>requirements.txt<span class="w">                                                                                                                                                                                                                                         </span><span class="m">0</span>.0s
</span><span id="__span-19-20"><a id="__codelineno-19-20" name="__codelineno-19-20" href="#__codelineno-19-20"></a><span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span>CACHED<span class="w"> </span><span class="o">[</span>spark-master<span class="w"> </span>pyspark<span class="w"> </span><span class="m">3</span>/4<span class="o">]</span><span class="w"> </span>COPY<span class="w"> </span>conf/spark-defaults.conf<span class="w"> </span>/opt/spark/conf<span class="w">                                                                                                                                                                                                                                </span><span class="m">0</span>.0s
</span><span id="__span-19-21"><a id="__codelineno-19-21" name="__codelineno-19-21" href="#__codelineno-19-21"></a><span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span>CACHED<span class="w"> </span><span class="o">[</span>spark-master<span class="w"> </span>pyspark<span class="w"> </span><span class="m">4</span>/4<span class="o">]</span><span class="w"> </span>RUN<span class="w"> </span>chmod<span class="w"> </span>u+x<span class="w"> </span>/opt/spark/sbin/*<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w">     </span>chmod<span class="w"> </span>u+x<span class="w"> </span>/opt/spark/bin/*<span class="w">                                                                                                                                                                                                            </span><span class="m">0</span>.0s
</span><span id="__span-19-22"><a id="__codelineno-19-22" name="__codelineno-19-22" href="#__codelineno-19-22"></a><span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span>CACHED<span class="w"> </span><span class="o">[</span>spark-master<span class="w"> </span>stage-2<span class="w"> </span><span class="m">1</span>/6<span class="o">]</span><span class="w"> </span>RUN<span class="w"> </span>curl<span class="w"> </span>https://repo1.maven.org/maven2/org/apache/iceberg/iceberg-spark-runtime-3.4_2.12/1.4.3/iceberg-spark-runtime-3.4_2.12-1.4.3.jar<span class="w"> </span>-Lo<span class="w"> </span>/opt/spark/jars/iceberg-spark-runtime-3.4_2.12-1.4.3.jar<span class="w">                                                                        </span><span class="m">0</span>.0s
</span><span id="__span-19-23"><a id="__codelineno-19-23" name="__codelineno-19-23" href="#__codelineno-19-23"></a><span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span>CACHED<span class="w"> </span><span class="o">[</span>spark-master<span class="w"> </span>stage-2<span class="w"> </span><span class="m">2</span>/6<span class="o">]</span><span class="w"> </span>RUN<span class="w"> </span>curl<span class="w"> </span>https://repo1.maven.org/maven2/io/delta/delta-core_2.12/2.4.0/delta-core_2.12-2.4.0.jar<span class="w"> </span>-Lo<span class="w"> </span>/opt/spark/jars/delta-core_2.12-2.4.0.jar<span class="w">                                                                                                                               </span><span class="m">0</span>.0s
</span><span id="__span-19-24"><a id="__codelineno-19-24" name="__codelineno-19-24" href="#__codelineno-19-24"></a><span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span>CACHED<span class="w"> </span><span class="o">[</span>spark-master<span class="w"> </span>stage-2<span class="w"> </span><span class="m">3</span>/6<span class="o">]</span><span class="w"> </span>RUN<span class="w"> </span>curl<span class="w"> </span>https://repo1.maven.org/maven2/io/delta/delta-spark_2.12/3.2.0/delta-spark_2.12-3.2.0.jar<span class="w"> </span>-Lo<span class="w"> </span>/opt/spark/jars/delta-spark_2.12-3.2.0.jar<span class="w">                                                                                                                            </span><span class="m">0</span>.0s
</span><span id="__span-19-25"><a id="__codelineno-19-25" name="__codelineno-19-25" href="#__codelineno-19-25"></a><span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span>CACHED<span class="w"> </span><span class="o">[</span>spark-master<span class="w"> </span>stage-2<span class="w"> </span><span class="m">4</span>/6<span class="o">]</span><span class="w"> </span>RUN<span class="w"> </span>curl<span class="w"> </span>https://repo1.maven.org/maven2/io/delta/delta-storage/3.2.0/delta-storage-3.2.0.jar<span class="w"> </span>-Lo<span class="w"> </span>/opt/spark/jars/delta-storage-3.2.0.jar<span class="w">                                                                                                                                     </span><span class="m">0</span>.0s
</span><span id="__span-19-26"><a id="__codelineno-19-26" name="__codelineno-19-26" href="#__codelineno-19-26"></a><span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span><span class="o">[</span>spark-master<span class="w"> </span>stage-2<span class="w"> </span><span class="m">5</span>/6<span class="o">]</span><span class="w"> </span>COPY<span class="w"> </span>entrypoint.sh<span class="w"> </span>.<span class="w">                                                                                                                                                                                                                                                                </span><span class="m">0</span>.0s
</span><span id="__span-19-27"><a id="__codelineno-19-27" name="__codelineno-19-27" href="#__codelineno-19-27"></a><span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span><span class="o">[</span>spark-master<span class="w"> </span>stage-2<span class="w"> </span><span class="m">6</span>/6<span class="o">]</span><span class="w"> </span>RUN<span class="w"> </span>chmod<span class="w"> </span>u+x<span class="w"> </span>/opt/spark/entrypoint.sh<span class="w">                                                                                                                                                                                                                                              </span><span class="m">0</span>.1s
</span><span id="__span-19-28"><a id="__codelineno-19-28" name="__codelineno-19-28" href="#__codelineno-19-28"></a><span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span><span class="o">[</span>spark-master<span class="o">]</span><span class="w"> </span>exporting<span class="w"> </span>to<span class="w"> </span>image<span class="w">                                                                                                                                                                                                                                                                              </span><span class="m">0</span>.0s
</span><span id="__span-19-29"><a id="__codelineno-19-29" name="__codelineno-19-29" href="#__codelineno-19-29"></a><span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span>exporting<span class="w"> </span>layers<span class="w">                                                                                                                                                                                                                                                                                            </span><span class="m">0</span>.0s
</span><span id="__span-19-30"><a id="__codelineno-19-30" name="__codelineno-19-30" href="#__codelineno-19-30"></a><span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span>writing<span class="w"> </span>image<span class="w"> </span>sha256:e9e8d30b8debaa1194efcb691c192c7bf21c7ac7ee32bad255d0a91440fee562<span class="w">                                                                                                                                                                                                                       </span><span class="m">0</span>.0s
</span><span id="__span-19-31"><a id="__codelineno-19-31" name="__codelineno-19-31" href="#__codelineno-19-31"></a><span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span>naming<span class="w"> </span>to<span class="w"> </span>docker.io/library/spark-image<span class="w">                                                                                                                                                                                                                                                                     </span><span class="m">0</span>.0s
</span><span id="__span-19-32"><a id="__codelineno-19-32" name="__codelineno-19-32" href="#__codelineno-19-32"></a><span class="o">[</span>+<span class="o">]</span><span class="w"> </span>Running<span class="w"> </span><span class="m">3</span>/3
</span><span id="__span-19-33"><a id="__codelineno-19-33" name="__codelineno-19-33" href="#__codelineno-19-33"></a><span class="w"> </span><span class="w"> </span>Container<span class="w"> </span>spark-master<span class="w">   </span>Started<span class="w">                                                                                                                                                                                                                                                                               </span><span class="m">20</span>.5s<span class="w"> </span>
</span><span id="__span-19-34"><a id="__codelineno-19-34" name="__codelineno-19-34" href="#__codelineno-19-34"></a><span class="w"> </span><span class="w"> </span>Container<span class="w"> </span>spark-history<span class="w">  </span>Started<span class="w">                                                                                                                                                                                                                                                                               </span><span class="m">10</span>.5s<span class="w"> </span>
</span><span id="__span-19-35"><a id="__codelineno-19-35" name="__codelineno-19-35" href="#__codelineno-19-35"></a><span class="w"> </span><span class="w"> </span>Container<span class="w"> </span>spark-worker<span class="w">   </span>Started<span class="w">    </span>
</span></code></pre></div>
<ul>
<li>Then, you need to enter the container interactive terminal, by running below command:</li>
</ul>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a>make<span class="w"> </span>dev
</span></code></pre></div>
<p>Output</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="o">(</span>base<span class="o">)</span><span class="w"> </span><span class="w">  </span>spark-docker<span class="w"> </span>git:<span class="o">(</span>main<span class="o">)</span><span class="w"> </span><span class="w"> </span>make<span class="w"> </span>dev
</span><span id="__span-21-2"><a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a>docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-it<span class="w"> </span>spark-master<span class="w"> </span>bash
</span><span id="__span-21-3"><a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a>root@6af4bb0bbdcf:/opt/spark#<span class="w"> </span>
</span></code></pre></div>
<ul>
<li>to execute the <code>delta-demo.py</code> script, you can run this command:</li>
</ul>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a>./bin/spark-submit<span class="w"> </span>scripts/delta-demo.py
</span></code></pre></div>
<h3 id="create-delta-table">Create delta table<a class="headerlink" href="#create-delta-table" title="Permanent link">#</a></h3>
<div class="language-python highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="c1"># Create a spark dataframe and write as a delta table</span>
</span><span id="__span-23-2"><a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Starting Delta table creation&quot;</span><span class="p">)</span>
</span><span id="__span-23-3"><a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a>
</span><span id="__span-23-4"><a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a><span class="n">data</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;Robert&quot;</span><span class="p">,</span> <span class="s2">&quot;Baratheon&quot;</span><span class="p">,</span> <span class="s2">&quot;Baratheon&quot;</span><span class="p">,</span> <span class="s2">&quot;Storms End&quot;</span><span class="p">,</span> <span class="mi">48</span><span class="p">),</span>
</span><span id="__span-23-5"><a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a>        <span class="p">(</span><span class="s2">&quot;Eddard&quot;</span><span class="p">,</span> <span class="s2">&quot;Stark&quot;</span><span class="p">,</span> <span class="s2">&quot;Stark&quot;</span><span class="p">,</span> <span class="s2">&quot;Winterfell&quot;</span><span class="p">,</span> <span class="mi">46</span><span class="p">),</span>
</span><span id="__span-23-6"><a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a>        <span class="p">(</span><span class="s2">&quot;Jamie&quot;</span><span class="p">,</span> <span class="s2">&quot;Lannister&quot;</span><span class="p">,</span> <span class="s2">&quot;Lannister&quot;</span><span class="p">,</span> <span class="s2">&quot;Casterly Rock&quot;</span><span class="p">,</span> <span class="mi">29</span><span class="p">)</span>
</span><span id="__span-23-7"><a id="__codelineno-23-7" name="__codelineno-23-7" href="#__codelineno-23-7"></a>        <span class="p">]</span>
</span><span id="__span-23-8"><a id="__codelineno-23-8" name="__codelineno-23-8" href="#__codelineno-23-8"></a><span class="n">schema</span> <span class="o">=</span> <span class="n">StructType</span><span class="p">([</span>
</span><span id="__span-23-9"><a id="__codelineno-23-9" name="__codelineno-23-9" href="#__codelineno-23-9"></a>    <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;firstname&quot;</span><span class="p">,</span> <span class="n">StringType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">),</span>
</span><span id="__span-23-10"><a id="__codelineno-23-10" name="__codelineno-23-10" href="#__codelineno-23-10"></a>    <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;lastname&quot;</span><span class="p">,</span> <span class="n">StringType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">),</span>
</span><span id="__span-23-11"><a id="__codelineno-23-11" name="__codelineno-23-11" href="#__codelineno-23-11"></a>    <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;house&quot;</span><span class="p">,</span> <span class="n">StringType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">),</span>
</span><span id="__span-23-12"><a id="__codelineno-23-12" name="__codelineno-23-12" href="#__codelineno-23-12"></a>    <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;location&quot;</span><span class="p">,</span> <span class="n">StringType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">),</span>
</span><span id="__span-23-13"><a id="__codelineno-23-13" name="__codelineno-23-13" href="#__codelineno-23-13"></a>    <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;age&quot;</span><span class="p">,</span> <span class="n">IntegerType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="__span-23-14"><a id="__codelineno-23-14" name="__codelineno-23-14" href="#__codelineno-23-14"></a><span class="p">])</span>
</span><span id="__span-23-15"><a id="__codelineno-23-15" name="__codelineno-23-15" href="#__codelineno-23-15"></a>
</span><span id="__span-23-16"><a id="__codelineno-23-16" name="__codelineno-23-16" href="#__codelineno-23-16"></a><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">createDataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">)</span>
</span><span id="__span-23-17"><a id="__codelineno-23-17" name="__codelineno-23-17" href="#__codelineno-23-17"></a><span class="n">df</span><span class="o">.</span><span class="n">write</span><span class="o">.</span><span class="n">mode</span><span class="p">(</span><span class="n">saveMode</span><span class="o">=</span><span class="s2">&quot;overwrite&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;delta&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;warehouse/delta-table&quot;</span><span class="p">)</span>
</span></code></pre></div>
<p>First, we define a spark DataFrame. In this case, we have the schema and input its data.</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a>Starting<span class="w"> </span>Delta<span class="w"> </span>table<span class="w"> </span>creation
</span><span id="__span-24-2"><a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a>+---------+---------+---------+-------------+---+
</span><span id="__span-24-3"><a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a><span class="p">|</span>firstname<span class="p">|</span><span class="w"> </span>lastname<span class="p">|</span><span class="w">    </span>house<span class="p">|</span><span class="w">     </span>location<span class="p">|</span>age<span class="p">|</span>
</span><span id="__span-24-4"><a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a>+---------+---------+---------+-------------+---+
</span><span id="__span-24-5"><a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a><span class="p">|</span><span class="w">   </span>Robert<span class="p">|</span>Baratheon<span class="p">|</span>Baratheon<span class="p">|</span><span class="w">   </span>Storms<span class="w"> </span>End<span class="p">|</span><span class="w"> </span><span class="m">48</span><span class="p">|</span>
</span><span id="__span-24-6"><a id="__codelineno-24-6" name="__codelineno-24-6" href="#__codelineno-24-6"></a><span class="p">|</span><span class="w">   </span>Eddard<span class="p">|</span><span class="w">    </span>Stark<span class="p">|</span><span class="w">    </span>Stark<span class="p">|</span><span class="w">   </span>Winterfell<span class="p">|</span><span class="w"> </span><span class="m">46</span><span class="p">|</span>
</span><span id="__span-24-7"><a id="__codelineno-24-7" name="__codelineno-24-7" href="#__codelineno-24-7"></a><span class="p">|</span><span class="w">    </span>Jamie<span class="p">|</span>Lannister<span class="p">|</span>Lannister<span class="p">|</span>Casterly<span class="w"> </span>Rock<span class="p">|</span><span class="w"> </span><span class="m">29</span><span class="p">|</span>
</span><span id="__span-24-8"><a id="__codelineno-24-8" name="__codelineno-24-8" href="#__codelineno-24-8"></a>+---------+---------+---------+-------------+---+
</span></code></pre></div>
<h3 id="read-delta-table">Read delta table<a class="headerlink" href="#read-delta-table" title="Permanent link">#</a></h3>
<p>Reading is as easy as again just specifying the <code>.format("delta")</code> in the spark read API</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="c1"># read from delta</span>
</span><span id="__span-25-2"><a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;delta&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;warehouse/delta-table&quot;</span><span class="p">)</span>
</span><span id="__span-25-3"><a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a><span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="__span-25-4"><a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a>
</span><span id="__span-25-5"><a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a><span class="c1"># print delta table schema</span>
</span><span id="__span-25-6"><a id="__codelineno-25-6" name="__codelineno-25-6" href="#__codelineno-25-6"></a><span class="n">df</span><span class="o">.</span><span class="n">printSchema</span><span class="p">()</span>
</span></code></pre></div>
<p>Output:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a>root
</span><span id="__span-26-2"><a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a><span class="w"> </span><span class="p">|</span>--<span class="w"> </span>firstname:<span class="w"> </span>string<span class="w"> </span><span class="o">(</span><span class="nv">nullable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="o">)</span>
</span><span id="__span-26-3"><a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a><span class="w"> </span><span class="p">|</span>--<span class="w"> </span>lastname:<span class="w"> </span>string<span class="w"> </span><span class="o">(</span><span class="nv">nullable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="o">)</span>
</span><span id="__span-26-4"><a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a><span class="w"> </span><span class="p">|</span>--<span class="w"> </span>house:<span class="w"> </span>string<span class="w"> </span><span class="o">(</span><span class="nv">nullable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="o">)</span>
</span><span id="__span-26-5"><a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a><span class="w"> </span><span class="p">|</span>--<span class="w"> </span>location:<span class="w"> </span>string<span class="w"> </span><span class="o">(</span><span class="nv">nullable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="o">)</span>
</span><span id="__span-26-6"><a id="__codelineno-26-6" name="__codelineno-26-6" href="#__codelineno-26-6"></a><span class="w"> </span><span class="p">|</span>--<span class="w"> </span>age:<span class="w"> </span>integer<span class="w"> </span><span class="o">(</span><span class="nv">nullable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="o">)</span>
</span></code></pre></div>
<h3 id="update-delta-table">Update delta table<a class="headerlink" href="#update-delta-table" title="Permanent link">#</a></h3>
<p>There are some approach to update data in delta table, such following:</p>
<h4 id="overwrite-whole-table">Overwrite whole table<a class="headerlink" href="#overwrite-whole-table" title="Permanent link">#</a></h4>
<p>In case you want to simply overwrite the delta table, you can simply provide <code>.mode(saveMode="overwrite")</code> command.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="c1"># Update data</span>
</span><span id="__span-27-2"><a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Updating Delta table...!&quot;</span><span class="p">)</span>
</span><span id="__span-27-3"><a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a><span class="n">data</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;Robert&quot;</span><span class="p">,</span> <span class="s2">&quot;Baratheon&quot;</span><span class="p">,</span> <span class="s2">&quot;Baratheon&quot;</span><span class="p">,</span> <span class="s2">&quot;Storms End&quot;</span><span class="p">,</span> <span class="mi">49</span><span class="p">),</span>
</span><span id="__span-27-4"><a id="__codelineno-27-4" name="__codelineno-27-4" href="#__codelineno-27-4"></a>        <span class="p">(</span><span class="s2">&quot;Eddard&quot;</span><span class="p">,</span> <span class="s2">&quot;Stark&quot;</span><span class="p">,</span> <span class="s2">&quot;Stark&quot;</span><span class="p">,</span> <span class="s2">&quot;Winterfell&quot;</span><span class="p">,</span> <span class="mi">47</span><span class="p">),</span>
</span><span id="__span-27-5"><a id="__codelineno-27-5" name="__codelineno-27-5" href="#__codelineno-27-5"></a>        <span class="p">(</span><span class="s2">&quot;Jamie&quot;</span><span class="p">,</span> <span class="s2">&quot;Lannister&quot;</span><span class="p">,</span> <span class="s2">&quot;Lannister&quot;</span><span class="p">,</span> <span class="s2">&quot;Casterly Rock&quot;</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
</span><span id="__span-27-6"><a id="__codelineno-27-6" name="__codelineno-27-6" href="#__codelineno-27-6"></a>        <span class="p">]</span>
</span><span id="__span-27-7"><a id="__codelineno-27-7" name="__codelineno-27-7" href="#__codelineno-27-7"></a><span class="n">schema</span> <span class="o">=</span> <span class="n">StructType</span><span class="p">([</span>
</span><span id="__span-27-8"><a id="__codelineno-27-8" name="__codelineno-27-8" href="#__codelineno-27-8"></a>    <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;firstname&quot;</span><span class="p">,</span> <span class="n">StringType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">),</span>
</span><span id="__span-27-9"><a id="__codelineno-27-9" name="__codelineno-27-9" href="#__codelineno-27-9"></a>    <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;lastname&quot;</span><span class="p">,</span> <span class="n">StringType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">),</span>
</span><span id="__span-27-10"><a id="__codelineno-27-10" name="__codelineno-27-10" href="#__codelineno-27-10"></a>    <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;house&quot;</span><span class="p">,</span> <span class="n">StringType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">),</span>
</span><span id="__span-27-11"><a id="__codelineno-27-11" name="__codelineno-27-11" href="#__codelineno-27-11"></a>    <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;location&quot;</span><span class="p">,</span> <span class="n">StringType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">),</span>
</span><span id="__span-27-12"><a id="__codelineno-27-12" name="__codelineno-27-12" href="#__codelineno-27-12"></a>    <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;age&quot;</span><span class="p">,</span> <span class="n">IntegerType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="__span-27-13"><a id="__codelineno-27-13" name="__codelineno-27-13" href="#__codelineno-27-13"></a><span class="p">])</span>
</span><span id="__span-27-14"><a id="__codelineno-27-14" name="__codelineno-27-14" href="#__codelineno-27-14"></a><span class="n">sample_dataframe</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">createDataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">)</span>
</span><span id="__span-27-15"><a id="__codelineno-27-15" name="__codelineno-27-15" href="#__codelineno-27-15"></a><span class="n">sample_dataframe</span><span class="o">.</span><span class="n">write</span><span class="o">.</span><span class="n">mode</span><span class="p">(</span><span class="n">saveMode</span><span class="o">=</span><span class="s2">&quot;overwrite&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;delta&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;warehouse/delta-table&quot;</span><span class="p">)</span>
</span></code></pre></div>
<p>Output</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a>Updating<span class="w"> </span>Delta<span class="w"> </span>table...!
</span><span id="__span-28-2"><a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a>Showing<span class="w"> </span>the<span class="w"> </span>data<span class="w"> </span>after<span class="w"> </span>being<span class="w"> </span>updated
</span><span id="__span-28-3"><a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a>+---------+---------+---------+-------------+---+
</span><span id="__span-28-4"><a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a><span class="p">|</span>firstname<span class="p">|</span><span class="w"> </span>lastname<span class="p">|</span><span class="w">    </span>house<span class="p">|</span><span class="w">     </span>location<span class="p">|</span>age<span class="p">|</span>
</span><span id="__span-28-5"><a id="__codelineno-28-5" name="__codelineno-28-5" href="#__codelineno-28-5"></a>+---------+---------+---------+-------------+---+
</span><span id="__span-28-6"><a id="__codelineno-28-6" name="__codelineno-28-6" href="#__codelineno-28-6"></a><span class="p">|</span><span class="w">   </span>Robert<span class="p">|</span>Baratheon<span class="p">|</span>Baratheon<span class="p">|</span><span class="w">   </span>Storms<span class="w"> </span>End<span class="p">|</span><span class="w"> </span><span class="m">49</span><span class="p">|</span>
</span><span id="__span-28-7"><a id="__codelineno-28-7" name="__codelineno-28-7" href="#__codelineno-28-7"></a><span class="p">|</span><span class="w">   </span>Eddard<span class="p">|</span><span class="w">    </span>Stark<span class="p">|</span><span class="w">    </span>Stark<span class="p">|</span><span class="w">   </span>Winterfell<span class="p">|</span><span class="w"> </span><span class="m">47</span><span class="p">|</span>
</span><span id="__span-28-8"><a id="__codelineno-28-8" name="__codelineno-28-8" href="#__codelineno-28-8"></a><span class="p">|</span><span class="w">    </span>Jamie<span class="p">|</span>Lannister<span class="p">|</span>Lannister<span class="p">|</span>Casterly<span class="w"> </span>Rock<span class="p">|</span><span class="w"> </span><span class="m">30</span><span class="p">|</span>
</span><span id="__span-28-9"><a id="__codelineno-28-9" name="__codelineno-28-9" href="#__codelineno-28-9"></a>+---------+---------+---------+-------------+---+
</span></code></pre></div>
<h4 id="conditional-update">Conditional Update<a class="headerlink" href="#conditional-update" title="Permanent link">#</a></h4>
<p>If you want to update a record or few records based on conditions, we can simply use the <code>.update</code> method</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="c1"># Update data in Delta</span>
</span><span id="__span-29-2"><a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Conditional Update...!&quot;</span><span class="p">)</span>
</span><span id="__span-29-3"><a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a>
</span><span id="__span-29-4"><a id="__codelineno-29-4" name="__codelineno-29-4" href="#__codelineno-29-4"></a><span class="c1"># delta table path</span>
</span><span id="__span-29-5"><a id="__codelineno-29-5" name="__codelineno-29-5" href="#__codelineno-29-5"></a><span class="n">deltaTable</span> <span class="o">=</span> <span class="n">DeltaTable</span><span class="o">.</span><span class="n">forPath</span><span class="p">(</span><span class="n">spark</span><span class="p">,</span> <span class="s2">&quot;warehouse/delta-table&quot;</span><span class="p">)</span>
</span><span id="__span-29-6"><a id="__codelineno-29-6" name="__codelineno-29-6" href="#__codelineno-29-6"></a><span class="n">deltaTable</span><span class="o">.</span><span class="n">toDF</span><span class="p">()</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="__span-29-7"><a id="__codelineno-29-7" name="__codelineno-29-7" href="#__codelineno-29-7"></a>
</span><span id="__span-29-8"><a id="__codelineno-29-8" name="__codelineno-29-8" href="#__codelineno-29-8"></a><span class="n">deltaTable</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
</span><span id="__span-29-9"><a id="__codelineno-29-9" name="__codelineno-29-9" href="#__codelineno-29-9"></a>    <span class="n">condition</span><span class="o">=</span><span class="n">expr</span><span class="p">(</span><span class="s2">&quot;firstname == &#39;Jamie&#39;&quot;</span><span class="p">),</span>
</span><span id="__span-29-10"><a id="__codelineno-29-10" name="__codelineno-29-10" href="#__codelineno-29-10"></a>    <span class="nb">set</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;firstname&quot;</span><span class="p">:</span> <span class="n">lit</span><span class="p">(</span><span class="s2">&quot;Jamie&quot;</span><span class="p">),</span> <span class="s2">&quot;lastname&quot;</span><span class="p">:</span> <span class="n">lit</span><span class="p">(</span><span class="s2">&quot;Lannister&quot;</span><span class="p">),</span> <span class="s2">&quot;house&quot;</span><span class="p">:</span> <span class="n">lit</span><span class="p">(</span><span class="s2">&quot;Lannister&quot;</span><span class="p">),</span>
</span><span id="__span-29-11"><a id="__codelineno-29-11" name="__codelineno-29-11" href="#__codelineno-29-11"></a>        <span class="s2">&quot;location&quot;</span><span class="p">:</span> <span class="n">lit</span><span class="p">(</span><span class="s2">&quot;Kings Landing&quot;</span><span class="p">),</span> <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="n">lit</span><span class="p">(</span><span class="mi">37</span><span class="p">)})</span>
</span><span id="__span-29-12"><a id="__codelineno-29-12" name="__codelineno-29-12" href="#__codelineno-29-12"></a>
</span><span id="__span-29-13"><a id="__codelineno-29-13" name="__codelineno-29-13" href="#__codelineno-29-13"></a><span class="n">deltaTable</span><span class="o">.</span><span class="n">toDF</span><span class="p">()</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></code></pre></div>
<p>Output</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a>Conditional<span class="w"> </span>Update...!
</span><span id="__span-30-2"><a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a>+---------+---------+---------+-------------+---+
</span><span id="__span-30-3"><a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a><span class="p">|</span>firstname<span class="p">|</span><span class="w"> </span>lastname<span class="p">|</span><span class="w">    </span>house<span class="p">|</span><span class="w">     </span>location<span class="p">|</span>age<span class="p">|</span>
</span><span id="__span-30-4"><a id="__codelineno-30-4" name="__codelineno-30-4" href="#__codelineno-30-4"></a>+---------+---------+---------+-------------+---+
</span><span id="__span-30-5"><a id="__codelineno-30-5" name="__codelineno-30-5" href="#__codelineno-30-5"></a><span class="hll"><span class="p">|</span><span class="w">    </span>Jamie<span class="p">|</span>Lannister<span class="p">|</span>Lannister<span class="p">|</span>Casterly<span class="w"> </span>Rock<span class="p">|</span><span class="w"> </span><span class="m">30</span><span class="p">|</span>
</span></span><span id="__span-30-6"><a id="__codelineno-30-6" name="__codelineno-30-6" href="#__codelineno-30-6"></a><span class="p">|</span><span class="w">   </span>Robert<span class="p">|</span>Baratheon<span class="p">|</span>Baratheon<span class="p">|</span><span class="w">   </span>Storms<span class="w"> </span>End<span class="p">|</span><span class="w"> </span><span class="m">49</span><span class="p">|</span>
</span><span id="__span-30-7"><a id="__codelineno-30-7" name="__codelineno-30-7" href="#__codelineno-30-7"></a><span class="p">|</span><span class="w">   </span>Eddard<span class="p">|</span><span class="w">    </span>Stark<span class="p">|</span><span class="w">    </span>Stark<span class="p">|</span><span class="w">   </span>Winterfell<span class="p">|</span><span class="w"> </span><span class="m">47</span><span class="p">|</span>
</span><span id="__span-30-8"><a id="__codelineno-30-8" name="__codelineno-30-8" href="#__codelineno-30-8"></a>+---------+---------+---------+-------------+---+
</span><span id="__span-30-9"><a id="__codelineno-30-9" name="__codelineno-30-9" href="#__codelineno-30-9"></a>
</span><span id="__span-30-10"><a id="__codelineno-30-10" name="__codelineno-30-10" href="#__codelineno-30-10"></a>+---------+---------+---------+-------------+---+
</span><span id="__span-30-11"><a id="__codelineno-30-11" name="__codelineno-30-11" href="#__codelineno-30-11"></a><span class="p">|</span>firstname<span class="p">|</span><span class="w"> </span>lastname<span class="p">|</span><span class="w">    </span>house<span class="p">|</span><span class="w">     </span>location<span class="p">|</span>age<span class="p">|</span>
</span><span id="__span-30-12"><a id="__codelineno-30-12" name="__codelineno-30-12" href="#__codelineno-30-12"></a>+---------+---------+---------+-------------+---+
</span><span id="__span-30-13"><a id="__codelineno-30-13" name="__codelineno-30-13" href="#__codelineno-30-13"></a><span class="hll"><span class="p">|</span><span class="w">    </span>Jamie<span class="p">|</span>Lannister<span class="p">|</span>Lannister<span class="p">|</span>Kings<span class="w"> </span>Landing<span class="p">|</span><span class="w"> </span><span class="m">37</span><span class="p">|</span>
</span></span><span id="__span-30-14"><a id="__codelineno-30-14" name="__codelineno-30-14" href="#__codelineno-30-14"></a><span class="p">|</span><span class="w">   </span>Robert<span class="p">|</span>Baratheon<span class="p">|</span>Baratheon<span class="p">|</span><span class="w">   </span>Storms<span class="w"> </span>End<span class="p">|</span><span class="w"> </span><span class="m">49</span><span class="p">|</span>
</span><span id="__span-30-15"><a id="__codelineno-30-15" name="__codelineno-30-15" href="#__codelineno-30-15"></a><span class="p">|</span><span class="w">   </span>Eddard<span class="p">|</span><span class="w">    </span>Stark<span class="p">|</span><span class="w">    </span>Stark<span class="p">|</span><span class="w">   </span>Winterfell<span class="p">|</span><span class="w"> </span><span class="m">47</span><span class="p">|</span>
</span><span id="__span-30-16"><a id="__codelineno-30-16" name="__codelineno-30-16" href="#__codelineno-30-16"></a>+---------+---------+---------+-------------+---+
</span></code></pre></div>
<h3 id="upsert-delta-table">Upsert delta table<a class="headerlink" href="#upsert-delta-table" title="Permanent link">#</a></h3>
<p><strong>Upsert</strong> is simply a combination of 2 operations (update and insert).
In order to upsert records, we will need to run the code below:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-31-1"><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a><span class="c1"># Upsert Data</span>
</span><span id="__span-31-2"><a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Upserting Data...!&quot;</span><span class="p">)</span>
</span><span id="__span-31-3"><a id="__codelineno-31-3" name="__codelineno-31-3" href="#__codelineno-31-3"></a><span class="c1"># delta table path</span>
</span><span id="__span-31-4"><a id="__codelineno-31-4" name="__codelineno-31-4" href="#__codelineno-31-4"></a><span class="n">deltaTable</span> <span class="o">=</span> <span class="n">DeltaTable</span><span class="o">.</span><span class="n">forPath</span><span class="p">(</span><span class="n">spark</span><span class="p">,</span> <span class="s2">&quot;warehouse/delta-table&quot;</span><span class="p">)</span>
</span><span id="__span-31-5"><a id="__codelineno-31-5" name="__codelineno-31-5" href="#__codelineno-31-5"></a><span class="n">deltaTable</span><span class="o">.</span><span class="n">toDF</span><span class="p">()</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="__span-31-6"><a id="__codelineno-31-6" name="__codelineno-31-6" href="#__codelineno-31-6"></a>
</span><span id="__span-31-7"><a id="__codelineno-31-7" name="__codelineno-31-7" href="#__codelineno-31-7"></a><span class="c1"># define new data</span>
</span><span id="__span-31-8"><a id="__codelineno-31-8" name="__codelineno-31-8" href="#__codelineno-31-8"></a><span class="n">data</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;Gendry&quot;</span><span class="p">,</span> <span class="s2">&quot;Baratheon&quot;</span><span class="p">,</span> <span class="s2">&quot;Baratheon&quot;</span><span class="p">,</span> <span class="s2">&quot;Kings Landing&quot;</span><span class="p">,</span> <span class="mi">19</span><span class="p">),</span>
</span><span id="__span-31-9"><a id="__codelineno-31-9" name="__codelineno-31-9" href="#__codelineno-31-9"></a>        <span class="p">(</span><span class="s2">&quot;Jon&quot;</span><span class="p">,</span> <span class="s2">&quot;Snow&quot;</span><span class="p">,</span> <span class="s2">&quot;Stark&quot;</span><span class="p">,</span> <span class="s2">&quot;Winterfell&quot;</span><span class="p">,</span> <span class="mi">21</span><span class="p">),</span>
</span><span id="__span-31-10"><a id="__codelineno-31-10" name="__codelineno-31-10" href="#__codelineno-31-10"></a>        <span class="p">(</span><span class="s2">&quot;Jamie&quot;</span><span class="p">,</span> <span class="s2">&quot;Lannister&quot;</span><span class="p">,</span> <span class="s2">&quot;Lannister&quot;</span><span class="p">,</span> <span class="s2">&quot;Casterly Rock&quot;</span><span class="p">,</span> <span class="mi">36</span><span class="p">)</span>
</span><span id="__span-31-11"><a id="__codelineno-31-11" name="__codelineno-31-11" href="#__codelineno-31-11"></a>        <span class="p">]</span>
</span><span id="__span-31-12"><a id="__codelineno-31-12" name="__codelineno-31-12" href="#__codelineno-31-12"></a><span class="n">schema</span> <span class="o">=</span> <span class="n">StructType</span><span class="p">([</span>
</span><span id="__span-31-13"><a id="__codelineno-31-13" name="__codelineno-31-13" href="#__codelineno-31-13"></a>    <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;firstname&quot;</span><span class="p">,</span> <span class="n">StringType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">),</span>
</span><span id="__span-31-14"><a id="__codelineno-31-14" name="__codelineno-31-14" href="#__codelineno-31-14"></a>    <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;lastname&quot;</span><span class="p">,</span> <span class="n">StringType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">),</span>
</span><span id="__span-31-15"><a id="__codelineno-31-15" name="__codelineno-31-15" href="#__codelineno-31-15"></a>    <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;house&quot;</span><span class="p">,</span> <span class="n">StringType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">),</span>
</span><span id="__span-31-16"><a id="__codelineno-31-16" name="__codelineno-31-16" href="#__codelineno-31-16"></a>    <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;location&quot;</span><span class="p">,</span> <span class="n">StringType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">),</span>
</span><span id="__span-31-17"><a id="__codelineno-31-17" name="__codelineno-31-17" href="#__codelineno-31-17"></a>    <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;age&quot;</span><span class="p">,</span> <span class="n">IntegerType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="__span-31-18"><a id="__codelineno-31-18" name="__codelineno-31-18" href="#__codelineno-31-18"></a><span class="p">])</span>
</span><span id="__span-31-19"><a id="__codelineno-31-19" name="__codelineno-31-19" href="#__codelineno-31-19"></a>
</span><span id="__span-31-20"><a id="__codelineno-31-20" name="__codelineno-31-20" href="#__codelineno-31-20"></a><span class="n">newData</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">createDataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">)</span>
</span><span id="__span-31-21"><a id="__codelineno-31-21" name="__codelineno-31-21" href="#__codelineno-31-21"></a>
</span><span id="__span-31-22"><a id="__codelineno-31-22" name="__codelineno-31-22" href="#__codelineno-31-22"></a><span class="n">deltaTable</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;oldData&quot;</span><span class="p">)</span> \
</span><span id="__span-31-23"><a id="__codelineno-31-23" name="__codelineno-31-23" href="#__codelineno-31-23"></a>    <span class="o">.</span><span class="n">merge</span><span class="p">(</span>
</span><span id="__span-31-24"><a id="__codelineno-31-24" name="__codelineno-31-24" href="#__codelineno-31-24"></a>    <span class="n">newData</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;newData&quot;</span><span class="p">),</span>
</span><span id="__span-31-25"><a id="__codelineno-31-25" name="__codelineno-31-25" href="#__codelineno-31-25"></a>    <span class="s2">&quot;oldData.firstname = newData.firstname&quot;</span><span class="p">)</span> \
</span><span id="__span-31-26"><a id="__codelineno-31-26" name="__codelineno-31-26" href="#__codelineno-31-26"></a>    <span class="o">.</span><span class="n">whenMatchedUpdate</span><span class="p">(</span>
</span><span id="__span-31-27"><a id="__codelineno-31-27" name="__codelineno-31-27" href="#__codelineno-31-27"></a>    <span class="nb">set</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;firstname&quot;</span><span class="p">:</span> <span class="n">col</span><span class="p">(</span><span class="s2">&quot;newData.firstname&quot;</span><span class="p">),</span> <span class="s2">&quot;lastname&quot;</span><span class="p">:</span> <span class="n">col</span><span class="p">(</span><span class="s2">&quot;newData.lastname&quot;</span><span class="p">),</span> <span class="s2">&quot;house&quot;</span><span class="p">:</span> <span class="n">col</span><span class="p">(</span><span class="s2">&quot;newData.house&quot;</span><span class="p">),</span>
</span><span id="__span-31-28"><a id="__codelineno-31-28" name="__codelineno-31-28" href="#__codelineno-31-28"></a>        <span class="s2">&quot;location&quot;</span><span class="p">:</span> <span class="n">col</span><span class="p">(</span><span class="s2">&quot;newData.location&quot;</span><span class="p">),</span> <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="n">col</span><span class="p">(</span><span class="s2">&quot;newData.age&quot;</span><span class="p">)})</span> \
</span><span id="__span-31-29"><a id="__codelineno-31-29" name="__codelineno-31-29" href="#__codelineno-31-29"></a>    <span class="o">.</span><span class="n">whenNotMatchedInsert</span><span class="p">(</span>
</span><span id="__span-31-30"><a id="__codelineno-31-30" name="__codelineno-31-30" href="#__codelineno-31-30"></a>    <span class="n">values</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;firstname&quot;</span><span class="p">:</span> <span class="n">col</span><span class="p">(</span><span class="s2">&quot;newData.firstname&quot;</span><span class="p">),</span> <span class="s2">&quot;lastname&quot;</span><span class="p">:</span> <span class="n">col</span><span class="p">(</span><span class="s2">&quot;newData.lastname&quot;</span><span class="p">),</span> <span class="s2">&quot;house&quot;</span><span class="p">:</span> <span class="n">col</span><span class="p">(</span><span class="s2">&quot;newData.house&quot;</span><span class="p">),</span>
</span><span id="__span-31-31"><a id="__codelineno-31-31" name="__codelineno-31-31" href="#__codelineno-31-31"></a>            <span class="s2">&quot;location&quot;</span><span class="p">:</span> <span class="n">col</span><span class="p">(</span><span class="s2">&quot;newData.location&quot;</span><span class="p">),</span> <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="n">col</span><span class="p">(</span><span class="s2">&quot;newData.age&quot;</span><span class="p">)})</span> \
</span><span id="__span-31-32"><a id="__codelineno-31-32" name="__codelineno-31-32" href="#__codelineno-31-32"></a>    <span class="o">.</span><span class="n">execute</span><span class="p">()</span>
</span><span id="__span-31-33"><a id="__codelineno-31-33" name="__codelineno-31-33" href="#__codelineno-31-33"></a>
</span><span id="__span-31-34"><a id="__codelineno-31-34" name="__codelineno-31-34" href="#__codelineno-31-34"></a><span class="n">deltaTable</span><span class="o">.</span><span class="n">toDF</span><span class="p">()</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></code></pre></div>
<p>First, we define a new dataframe which has updates to "jamie" again with his "age" and then we have 2 new records for "Jon Snow" and "Gendry Baratheon".</p>
<p>The magic function that we use for upsert is <code>merge</code>.</p>
<p>In this case, we assign <code>alias</code> to the old and new dataframes and set the rules of what to do if a record matches with the existing data record.</p>
<p>The condition we're looking for is <code>oldData.firstName = newData.firstName</code>.
And, if it matches, we update everything to the new values</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-32-1"><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a><span class="o">.</span><span class="n">whenMatchedUpdate</span><span class="p">(</span>
</span><span id="__span-32-2"><a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a>    <span class="nb">set</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;firstname&quot;</span><span class="p">:</span> <span class="n">col</span><span class="p">(</span><span class="s2">&quot;newData.firstname&quot;</span><span class="p">),</span> <span class="s2">&quot;lastname&quot;</span><span class="p">:</span> <span class="n">col</span><span class="p">(</span><span class="s2">&quot;newData.lastname&quot;</span><span class="p">),</span> <span class="s2">&quot;house&quot;</span><span class="p">:</span> <span class="n">col</span><span class="p">(</span><span class="s2">&quot;newData.house&quot;</span><span class="p">),</span>
</span><span id="__span-32-3"><a id="__codelineno-32-3" name="__codelineno-32-3" href="#__codelineno-32-3"></a>           <span class="s2">&quot;location&quot;</span><span class="p">:</span> <span class="n">col</span><span class="p">(</span><span class="s2">&quot;newData.location&quot;</span><span class="p">),</span> <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="n">col</span><span class="p">(</span><span class="s2">&quot;newData.age&quot;</span><span class="p">)})</span>
</span></code></pre></div>
<p>If it doesn't match, it will execute and insert</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-33-1"><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a><span class="o">.</span><span class="n">whenNotMatchedInsert</span><span class="p">(</span>
</span><span id="__span-33-2"><a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a>    <span class="n">values</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;firstname&quot;</span><span class="p">:</span> <span class="n">col</span><span class="p">(</span><span class="s2">&quot;newData.firstname&quot;</span><span class="p">),</span> <span class="s2">&quot;lastname&quot;</span><span class="p">:</span> <span class="n">col</span><span class="p">(</span><span class="s2">&quot;newData.lastname&quot;</span><span class="p">),</span> <span class="s2">&quot;house&quot;</span><span class="p">:</span> <span class="n">col</span><span class="p">(</span><span class="s2">&quot;newData.house&quot;</span><span class="p">),</span>
</span><span id="__span-33-3"><a id="__codelineno-33-3" name="__codelineno-33-3" href="#__codelineno-33-3"></a>            <span class="s2">&quot;location&quot;</span><span class="p">:</span> <span class="n">col</span><span class="p">(</span><span class="s2">&quot;newData.location&quot;</span><span class="p">),</span> <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="n">col</span><span class="p">(</span><span class="s2">&quot;newData.age&quot;</span><span class="p">)})</span>
</span></code></pre></div>
<p>if we take a look at before and after of our operation on the dataframe, we can clearly see that the records have been upserted correctly.</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-34-1"><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a>Upserting<span class="w"> </span>Data...!
</span><span id="__span-34-2"><a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a>+---------+---------+---------+-------------+---+
</span><span id="__span-34-3"><a id="__codelineno-34-3" name="__codelineno-34-3" href="#__codelineno-34-3"></a><span class="p">|</span>firstname<span class="p">|</span><span class="w"> </span>lastname<span class="p">|</span><span class="w">    </span>house<span class="p">|</span><span class="w">     </span>location<span class="p">|</span>age<span class="p">|</span>
</span><span id="__span-34-4"><a id="__codelineno-34-4" name="__codelineno-34-4" href="#__codelineno-34-4"></a>+---------+---------+---------+-------------+---+
</span><span id="__span-34-5"><a id="__codelineno-34-5" name="__codelineno-34-5" href="#__codelineno-34-5"></a><span class="hll"><span class="p">|</span><span class="w">    </span>Jamie<span class="p">|</span>Lannister<span class="p">|</span>Lannister<span class="p">|</span>Kings<span class="w"> </span>Landing<span class="p">|</span><span class="w"> </span><span class="m">37</span><span class="p">|</span>
</span></span><span id="__span-34-6"><a id="__codelineno-34-6" name="__codelineno-34-6" href="#__codelineno-34-6"></a><span class="p">|</span><span class="w">   </span>Robert<span class="p">|</span>Baratheon<span class="p">|</span>Baratheon<span class="p">|</span><span class="w">   </span>Storms<span class="w"> </span>End<span class="p">|</span><span class="w"> </span><span class="m">49</span><span class="p">|</span>
</span><span id="__span-34-7"><a id="__codelineno-34-7" name="__codelineno-34-7" href="#__codelineno-34-7"></a><span class="p">|</span><span class="w">   </span>Eddard<span class="p">|</span><span class="w">    </span>Stark<span class="p">|</span><span class="w">    </span>Stark<span class="p">|</span><span class="w">   </span>Winterfell<span class="p">|</span><span class="w"> </span><span class="m">47</span><span class="p">|</span>
</span><span id="__span-34-8"><a id="__codelineno-34-8" name="__codelineno-34-8" href="#__codelineno-34-8"></a>+---------+---------+---------+-------------+---+
</span><span id="__span-34-9"><a id="__codelineno-34-9" name="__codelineno-34-9" href="#__codelineno-34-9"></a>
</span><span id="__span-34-10"><a id="__codelineno-34-10" name="__codelineno-34-10" href="#__codelineno-34-10"></a>+---------+---------+---------+-------------+---+
</span><span id="__span-34-11"><a id="__codelineno-34-11" name="__codelineno-34-11" href="#__codelineno-34-11"></a><span class="p">|</span>firstname<span class="p">|</span><span class="w"> </span>lastname<span class="p">|</span><span class="w">    </span>house<span class="p">|</span><span class="w">     </span>location<span class="p">|</span>age<span class="p">|</span>
</span><span id="__span-34-12"><a id="__codelineno-34-12" name="__codelineno-34-12" href="#__codelineno-34-12"></a>+---------+---------+---------+-------------+---+
</span><span id="__span-34-13"><a id="__codelineno-34-13" name="__codelineno-34-13" href="#__codelineno-34-13"></a><span class="hll"><span class="p">|</span><span class="w">   </span>Gendry<span class="p">|</span>Baratheon<span class="p">|</span>Baratheon<span class="p">|</span>Kings<span class="w"> </span>Landing<span class="p">|</span><span class="w"> </span><span class="m">19</span><span class="p">|</span>
</span></span><span id="__span-34-14"><a id="__codelineno-34-14" name="__codelineno-34-14" href="#__codelineno-34-14"></a><span class="hll"><span class="p">|</span><span class="w">    </span>Jamie<span class="p">|</span>Lannister<span class="p">|</span>Lannister<span class="p">|</span>Casterly<span class="w"> </span>Rock<span class="p">|</span><span class="w"> </span><span class="m">36</span><span class="p">|</span>
</span></span><span id="__span-34-15"><a id="__codelineno-34-15" name="__codelineno-34-15" href="#__codelineno-34-15"></a><span class="hll"><span class="p">|</span><span class="w">      </span>Jon<span class="p">|</span><span class="w">     </span>Snow<span class="p">|</span><span class="w">    </span>Stark<span class="p">|</span><span class="w">   </span>Winterfell<span class="p">|</span><span class="w"> </span><span class="m">21</span><span class="p">|</span>
</span></span><span id="__span-34-16"><a id="__codelineno-34-16" name="__codelineno-34-16" href="#__codelineno-34-16"></a><span class="p">|</span><span class="w">   </span>Robert<span class="p">|</span>Baratheon<span class="p">|</span>Baratheon<span class="p">|</span><span class="w">   </span>Storms<span class="w"> </span>End<span class="p">|</span><span class="w"> </span><span class="m">49</span><span class="p">|</span>
</span><span id="__span-34-17"><a id="__codelineno-34-17" name="__codelineno-34-17" href="#__codelineno-34-17"></a><span class="p">|</span><span class="w">   </span>Eddard<span class="p">|</span><span class="w">    </span>Stark<span class="p">|</span><span class="w">    </span>Stark<span class="p">|</span><span class="w">   </span>Winterfell<span class="p">|</span><span class="w"> </span><span class="m">47</span><span class="p">|</span>
</span><span id="__span-34-18"><a id="__codelineno-34-18" name="__codelineno-34-18" href="#__codelineno-34-18"></a>+---------+---------+---------+-------------+---+
</span></code></pre></div>
<h3 id="delete-delta-table">Delete delta table<a class="headerlink" href="#delete-delta-table" title="Permanent link">#</a></h3>
<p>We can also delete a particular record based on filters just like we did for update</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-35-1"><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a><span class="c1"># Delete Data</span>
</span><span id="__span-35-2"><a id="__codelineno-35-2" name="__codelineno-35-2" href="#__codelineno-35-2"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Deleting data...!&quot;</span><span class="p">)</span>
</span><span id="__span-35-3"><a id="__codelineno-35-3" name="__codelineno-35-3" href="#__codelineno-35-3"></a>
</span><span id="__span-35-4"><a id="__codelineno-35-4" name="__codelineno-35-4" href="#__codelineno-35-4"></a><span class="c1"># delta table path</span>
</span><span id="__span-35-5"><a id="__codelineno-35-5" name="__codelineno-35-5" href="#__codelineno-35-5"></a><span class="n">deltaTable</span> <span class="o">=</span> <span class="n">DeltaTable</span><span class="o">.</span><span class="n">forPath</span><span class="p">(</span><span class="n">spark</span><span class="p">,</span> <span class="s2">&quot;warehouse/delta-table&quot;</span><span class="p">)</span>
</span><span id="__span-35-6"><a id="__codelineno-35-6" name="__codelineno-35-6" href="#__codelineno-35-6"></a><span class="n">deltaTable</span><span class="o">.</span><span class="n">toDF</span><span class="p">()</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="__span-35-7"><a id="__codelineno-35-7" name="__codelineno-35-7" href="#__codelineno-35-7"></a>
</span><span id="__span-35-8"><a id="__codelineno-35-8" name="__codelineno-35-8" href="#__codelineno-35-8"></a><span class="n">deltaTable</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">condition</span><span class="o">=</span><span class="n">expr</span><span class="p">(</span><span class="s2">&quot;firstname == &#39;Gendry&#39;&quot;</span><span class="p">))</span>
</span><span id="__span-35-9"><a id="__codelineno-35-9" name="__codelineno-35-9" href="#__codelineno-35-9"></a>
</span><span id="__span-35-10"><a id="__codelineno-35-10" name="__codelineno-35-10" href="#__codelineno-35-10"></a><span class="n">deltaTable</span><span class="o">.</span><span class="n">toDF</span><span class="p">()</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></code></pre></div>
<p>In this case, we deleted the record for "Gendry" and it's reflected in the dataframe.</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-36-1"><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a>Deleting<span class="w"> </span>data...!
</span><span id="__span-36-2"><a id="__codelineno-36-2" name="__codelineno-36-2" href="#__codelineno-36-2"></a>+---------+---------+---------+-------------+---+
</span><span id="__span-36-3"><a id="__codelineno-36-3" name="__codelineno-36-3" href="#__codelineno-36-3"></a><span class="p">|</span>firstname<span class="p">|</span><span class="w"> </span>lastname<span class="p">|</span><span class="w">    </span>house<span class="p">|</span><span class="w">     </span>location<span class="p">|</span>age<span class="p">|</span>
</span><span id="__span-36-4"><a id="__codelineno-36-4" name="__codelineno-36-4" href="#__codelineno-36-4"></a>+---------+---------+---------+-------------+---+
</span><span id="__span-36-5"><a id="__codelineno-36-5" name="__codelineno-36-5" href="#__codelineno-36-5"></a><span class="hll"><span class="p">|</span><span class="w">   </span>Gendry<span class="p">|</span>Baratheon<span class="p">|</span>Baratheon<span class="p">|</span>Kings<span class="w"> </span>Landing<span class="p">|</span><span class="w"> </span><span class="m">19</span><span class="p">|</span>
</span></span><span id="__span-36-6"><a id="__codelineno-36-6" name="__codelineno-36-6" href="#__codelineno-36-6"></a><span class="p">|</span><span class="w">    </span>Jamie<span class="p">|</span>Lannister<span class="p">|</span>Lannister<span class="p">|</span>Casterly<span class="w"> </span>Rock<span class="p">|</span><span class="w"> </span><span class="m">36</span><span class="p">|</span>
</span><span id="__span-36-7"><a id="__codelineno-36-7" name="__codelineno-36-7" href="#__codelineno-36-7"></a><span class="p">|</span><span class="w">      </span>Jon<span class="p">|</span><span class="w">     </span>Snow<span class="p">|</span><span class="w">    </span>Stark<span class="p">|</span><span class="w">   </span>Winterfell<span class="p">|</span><span class="w"> </span><span class="m">21</span><span class="p">|</span>
</span><span id="__span-36-8"><a id="__codelineno-36-8" name="__codelineno-36-8" href="#__codelineno-36-8"></a><span class="p">|</span><span class="w">   </span>Robert<span class="p">|</span>Baratheon<span class="p">|</span>Baratheon<span class="p">|</span><span class="w">   </span>Storms<span class="w"> </span>End<span class="p">|</span><span class="w"> </span><span class="m">49</span><span class="p">|</span>
</span><span id="__span-36-9"><a id="__codelineno-36-9" name="__codelineno-36-9" href="#__codelineno-36-9"></a><span class="p">|</span><span class="w">   </span>Eddard<span class="p">|</span><span class="w">    </span>Stark<span class="p">|</span><span class="w">    </span>Stark<span class="p">|</span><span class="w">   </span>Winterfell<span class="p">|</span><span class="w"> </span><span class="m">47</span><span class="p">|</span>
</span><span id="__span-36-10"><a id="__codelineno-36-10" name="__codelineno-36-10" href="#__codelineno-36-10"></a>+---------+---------+---------+-------------+---+
</span><span id="__span-36-11"><a id="__codelineno-36-11" name="__codelineno-36-11" href="#__codelineno-36-11"></a>
</span><span id="__span-36-12"><a id="__codelineno-36-12" name="__codelineno-36-12" href="#__codelineno-36-12"></a>+---------+---------+---------+-------------+---+
</span><span id="__span-36-13"><a id="__codelineno-36-13" name="__codelineno-36-13" href="#__codelineno-36-13"></a><span class="p">|</span>firstname<span class="p">|</span><span class="w"> </span>lastname<span class="p">|</span><span class="w">    </span>house<span class="p">|</span><span class="w">     </span>location<span class="p">|</span>age<span class="p">|</span>
</span><span id="__span-36-14"><a id="__codelineno-36-14" name="__codelineno-36-14" href="#__codelineno-36-14"></a>+---------+---------+---------+-------------+---+
</span><span id="__span-36-15"><a id="__codelineno-36-15" name="__codelineno-36-15" href="#__codelineno-36-15"></a><span class="p">|</span><span class="w">   </span>Robert<span class="p">|</span>Baratheon<span class="p">|</span>Baratheon<span class="p">|</span><span class="w">   </span>Storms<span class="w"> </span>End<span class="p">|</span><span class="w"> </span><span class="m">49</span><span class="p">|</span>
</span><span id="__span-36-16"><a id="__codelineno-36-16" name="__codelineno-36-16" href="#__codelineno-36-16"></a><span class="p">|</span><span class="w">   </span>Eddard<span class="p">|</span><span class="w">    </span>Stark<span class="p">|</span><span class="w">    </span>Stark<span class="p">|</span><span class="w">   </span>Winterfell<span class="p">|</span><span class="w"> </span><span class="m">47</span><span class="p">|</span>
</span><span id="__span-36-17"><a id="__codelineno-36-17" name="__codelineno-36-17" href="#__codelineno-36-17"></a><span class="p">|</span><span class="w">    </span>Jamie<span class="p">|</span>Lannister<span class="p">|</span>Lannister<span class="p">|</span>Casterly<span class="w"> </span>Rock<span class="p">|</span><span class="w"> </span><span class="m">36</span><span class="p">|</span>
</span><span id="__span-36-18"><a id="__codelineno-36-18" name="__codelineno-36-18" href="#__codelineno-36-18"></a><span class="p">|</span><span class="w">      </span>Jon<span class="p">|</span><span class="w">     </span>Snow<span class="p">|</span><span class="w">    </span>Stark<span class="p">|</span><span class="w">   </span>Winterfell<span class="p">|</span><span class="w"> </span><span class="m">21</span><span class="p">|</span>
</span><span id="__span-36-19"><a id="__codelineno-36-19" name="__codelineno-36-19" href="#__codelineno-36-19"></a>+---------+---------+---------+-------------+---+
</span></code></pre></div>
<h3 id="time-travel_1">Time Travel<a class="headerlink" href="#time-travel_1" title="Permanent link">#</a></h3>
<p>Delta lake also allows you to read differnt historic versions of the data. the version history is stored in the <code>_delta_log</code> folder. we can inspect it to exactly know the kind of operation that happened on that point in time.</p>
<p><img alt="delta-logs-folder" src="../pics/delta-logs-folder.png" /></p>
<p>In order to read the data, you can specify versions and read like a normal dataframe.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-37-1"><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a><span class="c1"># Reading Older version of Data</span>
</span><span id="__span-37-2"><a id="__codelineno-37-2" name="__codelineno-37-2" href="#__codelineno-37-2"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Read old data...!&quot;</span><span class="p">)</span>
</span><span id="__span-37-3"><a id="__codelineno-37-3" name="__codelineno-37-3" href="#__codelineno-37-3"></a>
</span><span id="__span-37-4"><a id="__codelineno-37-4" name="__codelineno-37-4" href="#__codelineno-37-4"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Dataframe Version 0&quot;</span><span class="p">)</span>
</span><span id="__span-37-5"><a id="__codelineno-37-5" name="__codelineno-37-5" href="#__codelineno-37-5"></a><span class="n">df_ver0</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;delta&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;versionAsOf&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;warehouse/delta-table&quot;</span><span class="p">)</span>
</span><span id="__span-37-6"><a id="__codelineno-37-6" name="__codelineno-37-6" href="#__codelineno-37-6"></a><span class="n">df_ver0</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="__span-37-7"><a id="__codelineno-37-7" name="__codelineno-37-7" href="#__codelineno-37-7"></a>
</span><span id="__span-37-8"><a id="__codelineno-37-8" name="__codelineno-37-8" href="#__codelineno-37-8"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Dataframe Version 1&quot;</span><span class="p">)</span>
</span><span id="__span-37-9"><a id="__codelineno-37-9" name="__codelineno-37-9" href="#__codelineno-37-9"></a><span class="n">df_ver1</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;delta&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;versionAsOf&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;warehouse/delta-table&quot;</span><span class="p">)</span>
</span><span id="__span-37-10"><a id="__codelineno-37-10" name="__codelineno-37-10" href="#__codelineno-37-10"></a><span class="n">df_ver1</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></code></pre></div>
<p>Output</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-38-1"><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a>Read<span class="w"> </span>old<span class="w"> </span>data...!
</span><span id="__span-38-2"><a id="__codelineno-38-2" name="__codelineno-38-2" href="#__codelineno-38-2"></a>Dataframe<span class="w"> </span>Version<span class="w"> </span><span class="m">0</span>
</span><span id="__span-38-3"><a id="__codelineno-38-3" name="__codelineno-38-3" href="#__codelineno-38-3"></a>+---------+---------+---------+-------------+---+
</span><span id="__span-38-4"><a id="__codelineno-38-4" name="__codelineno-38-4" href="#__codelineno-38-4"></a><span class="p">|</span>firstname<span class="p">|</span><span class="w"> </span>lastname<span class="p">|</span><span class="w">    </span>house<span class="p">|</span><span class="w">     </span>location<span class="p">|</span>age<span class="p">|</span>
</span><span id="__span-38-5"><a id="__codelineno-38-5" name="__codelineno-38-5" href="#__codelineno-38-5"></a>+---------+---------+---------+-------------+---+
</span><span id="__span-38-6"><a id="__codelineno-38-6" name="__codelineno-38-6" href="#__codelineno-38-6"></a><span class="p">|</span><span class="w">   </span>Robert<span class="p">|</span>Baratheon<span class="p">|</span>Baratheon<span class="p">|</span><span class="w">   </span>Storms<span class="w"> </span>End<span class="p">|</span><span class="w"> </span><span class="m">48</span><span class="p">|</span>
</span><span id="__span-38-7"><a id="__codelineno-38-7" name="__codelineno-38-7" href="#__codelineno-38-7"></a><span class="p">|</span><span class="w">   </span>Eddard<span class="p">|</span><span class="w">    </span>Stark<span class="p">|</span><span class="w">    </span>Stark<span class="p">|</span><span class="w">   </span>Winterfell<span class="p">|</span><span class="w"> </span><span class="m">46</span><span class="p">|</span>
</span><span id="__span-38-8"><a id="__codelineno-38-8" name="__codelineno-38-8" href="#__codelineno-38-8"></a><span class="p">|</span><span class="w">    </span>Jamie<span class="p">|</span>Lannister<span class="p">|</span>Lannister<span class="p">|</span>Casterly<span class="w"> </span>Rock<span class="p">|</span><span class="w"> </span><span class="m">29</span><span class="p">|</span>
</span><span id="__span-38-9"><a id="__codelineno-38-9" name="__codelineno-38-9" href="#__codelineno-38-9"></a>+---------+---------+---------+-------------+---+
</span><span id="__span-38-10"><a id="__codelineno-38-10" name="__codelineno-38-10" href="#__codelineno-38-10"></a>
</span><span id="__span-38-11"><a id="__codelineno-38-11" name="__codelineno-38-11" href="#__codelineno-38-11"></a>Dataframe<span class="w"> </span>Version<span class="w"> </span><span class="m">1</span>
</span><span id="__span-38-12"><a id="__codelineno-38-12" name="__codelineno-38-12" href="#__codelineno-38-12"></a>+---------+---------+---------+-------------+---+
</span><span id="__span-38-13"><a id="__codelineno-38-13" name="__codelineno-38-13" href="#__codelineno-38-13"></a><span class="p">|</span>firstname<span class="p">|</span><span class="w"> </span>lastname<span class="p">|</span><span class="w">    </span>house<span class="p">|</span><span class="w">     </span>location<span class="p">|</span>age<span class="p">|</span>
</span><span id="__span-38-14"><a id="__codelineno-38-14" name="__codelineno-38-14" href="#__codelineno-38-14"></a>+---------+---------+---------+-------------+---+
</span><span id="__span-38-15"><a id="__codelineno-38-15" name="__codelineno-38-15" href="#__codelineno-38-15"></a><span class="p">|</span><span class="w">    </span>Jamie<span class="p">|</span>Lannister<span class="p">|</span>Lannister<span class="p">|</span>Casterly<span class="w"> </span>Rock<span class="p">|</span><span class="w"> </span><span class="m">30</span><span class="p">|</span>
</span><span id="__span-38-16"><a id="__codelineno-38-16" name="__codelineno-38-16" href="#__codelineno-38-16"></a><span class="p">|</span><span class="w">   </span>Robert<span class="p">|</span>Baratheon<span class="p">|</span>Baratheon<span class="p">|</span><span class="w">   </span>Storms<span class="w"> </span>End<span class="p">|</span><span class="w"> </span><span class="m">49</span><span class="p">|</span>
</span><span id="__span-38-17"><a id="__codelineno-38-17" name="__codelineno-38-17" href="#__codelineno-38-17"></a><span class="p">|</span><span class="w">   </span>Eddard<span class="p">|</span><span class="w">    </span>Stark<span class="p">|</span><span class="w">    </span>Stark<span class="p">|</span><span class="w">   </span>Winterfell<span class="p">|</span><span class="w"> </span><span class="m">47</span><span class="p">|</span>
</span><span id="__span-38-18"><a id="__codelineno-38-18" name="__codelineno-38-18" href="#__codelineno-38-18"></a>+---------+---------+---------+-------------+---+
</span></code></pre></div>
<h2 id="change-data-feed-cdc">Change Data Feed (CDC)<a class="headerlink" href="#change-data-feed-cdc" title="Permanent link">#</a></h2>
<p>Change Data Feed is customized CDC on top of Delta Lake, created by Databricks</p>
<p>Change data feed allows Databricks to track row-level changes between versions of a Delta table. When enabled on a Delta table, the runtime records change events for all the data written into the table. This includes the row data along with metadata indicating whether the specified row was inserted, deleted, or updated.</p>
<h3 id="incrementally-process-change-data">Incrementally process change data<a class="headerlink" href="#incrementally-process-change-data" title="Permanent link">#</a></h3>
<p>Databricks recommends using change data feed in combination with Structured Streaming to incrementally process changes from Delta tables. You must use Structured Streaming for Databricks to automatically track versions for your tables change data feed.</p>
<h3 id="quick-code">Quick Code<a class="headerlink" href="#quick-code" title="Permanent link">#</a></h3>
<p>You can take a look the quick code</p>
<div class="language-python highlight"><span class="filename">scripts/delta-cdc.py</span><pre><span></span><code><span id="__span-39-1"><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a><span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span>
</span><span id="__span-39-2"><a id="__codelineno-39-2" name="__codelineno-39-2" href="#__codelineno-39-2"></a><span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">expr</span>
</span><span id="__span-39-3"><a id="__codelineno-39-3" name="__codelineno-39-3" href="#__codelineno-39-3"></a><span class="kn">from</span> <span class="nn">delta.tables</span> <span class="kn">import</span> <span class="n">DeltaTable</span>
</span><span id="__span-39-4"><a id="__codelineno-39-4" name="__codelineno-39-4" href="#__codelineno-39-4"></a><span class="kn">import</span> <span class="nn">shutil</span>
</span><span id="__span-39-5"><a id="__codelineno-39-5" name="__codelineno-39-5" href="#__codelineno-39-5"></a>
</span><span id="__span-39-6"><a id="__codelineno-39-6" name="__codelineno-39-6" href="#__codelineno-39-6"></a>
</span><span id="__span-39-7"><a id="__codelineno-39-7" name="__codelineno-39-7" href="#__codelineno-39-7"></a><span class="n">path</span> <span class="o">=</span> <span class="s2">&quot;/tmp/delta-change-data-feed/student&quot;</span>
</span><span id="__span-39-8"><a id="__codelineno-39-8" name="__codelineno-39-8" href="#__codelineno-39-8"></a><span class="n">otherPath</span> <span class="o">=</span> <span class="s2">&quot;/tmp/delta-change-data-feed/student_source&quot;</span>
</span><span id="__span-39-9"><a id="__codelineno-39-9" name="__codelineno-39-9" href="#__codelineno-39-9"></a>
</span><span id="__span-39-10"><a id="__codelineno-39-10" name="__codelineno-39-10" href="#__codelineno-39-10"></a><span class="c1"># Enable SQL commands and Update/Delete/Merge for the current spark session.</span>
</span><span id="__span-39-11"><a id="__codelineno-39-11" name="__codelineno-39-11" href="#__codelineno-39-11"></a><span class="c1"># we need to set the following configs</span>
</span><span id="__span-39-12"><a id="__codelineno-39-12" name="__codelineno-39-12" href="#__codelineno-39-12"></a><span class="n">spark</span> <span class="o">=</span> <span class="n">SparkSession</span><span class="o">.</span><span class="n">builder</span> \
</span><span id="__span-39-13"><a id="__codelineno-39-13" name="__codelineno-39-13" href="#__codelineno-39-13"></a>    <span class="o">.</span><span class="n">appName</span><span class="p">(</span><span class="s2">&quot;Change Data Feed&quot;</span><span class="p">)</span> \
</span><span id="__span-39-14"><a id="__codelineno-39-14" name="__codelineno-39-14" href="#__codelineno-39-14"></a>    <span class="o">.</span><span class="n">master</span><span class="p">(</span><span class="s2">&quot;local[*]&quot;</span><span class="p">)</span> \
</span><span id="__span-39-15"><a id="__codelineno-39-15" name="__codelineno-39-15" href="#__codelineno-39-15"></a>    <span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="s2">&quot;spark.sql.extensions&quot;</span><span class="p">,</span> <span class="s2">&quot;io.delta.sql.DeltaSparkSessionExtension&quot;</span><span class="p">)</span> \
</span><span id="__span-39-16"><a id="__codelineno-39-16" name="__codelineno-39-16" href="#__codelineno-39-16"></a>    <span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="s2">&quot;spark.sql.catalog.spark_catalog&quot;</span><span class="p">,</span> <span class="s2">&quot;org.apache.spark.sql.delta.catalog.DeltaCatalog&quot;</span><span class="p">)</span> \
</span><span id="__span-39-17"><a id="__codelineno-39-17" name="__codelineno-39-17" href="#__codelineno-39-17"></a>    <span class="o">.</span><span class="n">getOrCreate</span><span class="p">()</span>
</span><span id="__span-39-18"><a id="__codelineno-39-18" name="__codelineno-39-18" href="#__codelineno-39-18"></a>
</span><span id="__span-39-19"><a id="__codelineno-39-19" name="__codelineno-39-19" href="#__codelineno-39-19"></a>
</span><span id="__span-39-20"><a id="__codelineno-39-20" name="__codelineno-39-20" href="#__codelineno-39-20"></a><span class="k">def</span> <span class="nf">cleanup</span><span class="p">():</span>
</span><span id="__span-39-21"><a id="__codelineno-39-21" name="__codelineno-39-21" href="#__codelineno-39-21"></a>    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-39-22"><a id="__codelineno-39-22" name="__codelineno-39-22" href="#__codelineno-39-22"></a>    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">otherPath</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-39-23"><a id="__codelineno-39-23" name="__codelineno-39-23" href="#__codelineno-39-23"></a>    <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s2">&quot;DROP TABLE IF EXISTS student&quot;</span><span class="p">)</span>
</span><span id="__span-39-24"><a id="__codelineno-39-24" name="__codelineno-39-24" href="#__codelineno-39-24"></a>    <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s2">&quot;DROP TABLE IF EXISTS student_source&quot;</span><span class="p">)</span>
</span><span id="__span-39-25"><a id="__codelineno-39-25" name="__codelineno-39-25" href="#__codelineno-39-25"></a>
</span><span id="__span-39-26"><a id="__codelineno-39-26" name="__codelineno-39-26" href="#__codelineno-39-26"></a>
</span><span id="__span-39-27"><a id="__codelineno-39-27" name="__codelineno-39-27" href="#__codelineno-39-27"></a><span class="k">def</span> <span class="nf">read_cdc_by_table_name</span><span class="p">(</span><span class="n">starting_version</span><span class="p">):</span>
</span><span id="__span-39-28"><a id="__codelineno-39-28" name="__codelineno-39-28" href="#__codelineno-39-28"></a>    <span class="k">return</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;delta&quot;</span><span class="p">)</span> \
</span><span id="__span-39-29"><a id="__codelineno-39-29" name="__codelineno-39-29" href="#__codelineno-39-29"></a>        <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;readChangeFeed&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">)</span> \
</span><span id="__span-39-30"><a id="__codelineno-39-30" name="__codelineno-39-30" href="#__codelineno-39-30"></a>        <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;startingVersion&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">starting_version</span><span class="p">))</span> \
</span><span id="__span-39-31"><a id="__codelineno-39-31" name="__codelineno-39-31" href="#__codelineno-39-31"></a>        <span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s2">&quot;student&quot;</span><span class="p">)</span> \
</span><span id="__span-39-32"><a id="__codelineno-39-32" name="__codelineno-39-32" href="#__codelineno-39-32"></a>        <span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="s2">&quot;_change_type&quot;</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">)</span>
</span><span id="__span-39-33"><a id="__codelineno-39-33" name="__codelineno-39-33" href="#__codelineno-39-33"></a>
</span><span id="__span-39-34"><a id="__codelineno-39-34" name="__codelineno-39-34" href="#__codelineno-39-34"></a>
</span><span id="__span-39-35"><a id="__codelineno-39-35" name="__codelineno-39-35" href="#__codelineno-39-35"></a><span class="k">def</span> <span class="nf">stream_cdc_by_table_name</span><span class="p">(</span><span class="n">starting_version</span><span class="p">):</span>
</span><span id="__span-39-36"><a id="__codelineno-39-36" name="__codelineno-39-36" href="#__codelineno-39-36"></a>    <span class="k">return</span> <span class="n">spark</span><span class="o">.</span><span class="n">readStream</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;delta&quot;</span><span class="p">)</span> \
</span><span id="__span-39-37"><a id="__codelineno-39-37" name="__codelineno-39-37" href="#__codelineno-39-37"></a>        <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;readChangeFeed&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">)</span> \
</span><span id="__span-39-38"><a id="__codelineno-39-38" name="__codelineno-39-38" href="#__codelineno-39-38"></a>        <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;startingVersion&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">starting_version</span><span class="p">))</span> \
</span><span id="__span-39-39"><a id="__codelineno-39-39" name="__codelineno-39-39" href="#__codelineno-39-39"></a>        <span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s2">&quot;student&quot;</span><span class="p">)</span> \
</span><span id="__span-39-40"><a id="__codelineno-39-40" name="__codelineno-39-40" href="#__codelineno-39-40"></a>        <span class="o">.</span><span class="n">writeStream</span> \
</span><span id="__span-39-41"><a id="__codelineno-39-41" name="__codelineno-39-41" href="#__codelineno-39-41"></a>        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;console&quot;</span><span class="p">)</span> \
</span><span id="__span-39-42"><a id="__codelineno-39-42" name="__codelineno-39-42" href="#__codelineno-39-42"></a>        <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;numRows&quot;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span> \
</span><span id="__span-39-43"><a id="__codelineno-39-43" name="__codelineno-39-43" href="#__codelineno-39-43"></a>        <span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span><span id="__span-39-44"><a id="__codelineno-39-44" name="__codelineno-39-44" href="#__codelineno-39-44"></a>
</span><span id="__span-39-45"><a id="__codelineno-39-45" name="__codelineno-39-45" href="#__codelineno-39-45"></a>
</span><span id="__span-39-46"><a id="__codelineno-39-46" name="__codelineno-39-46" href="#__codelineno-39-46"></a><span class="n">cleanup</span><span class="p">()</span>
</span><span id="__span-39-47"><a id="__codelineno-39-47" name="__codelineno-39-47" href="#__codelineno-39-47"></a>
</span><span id="__span-39-48"><a id="__codelineno-39-48" name="__codelineno-39-48" href="#__codelineno-39-48"></a><span class="k">try</span><span class="p">:</span>
</span><span id="__span-39-49"><a id="__codelineno-39-49" name="__codelineno-39-49" href="#__codelineno-39-49"></a>    <span class="c1"># =============== Create student table ===============</span>
</span><span id="__span-39-50"><a id="__codelineno-39-50" name="__codelineno-39-50" href="#__codelineno-39-50"></a>    <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;CREATE TABLE student (id INT, name STRING, age INT)</span>
</span><span id="__span-39-51"><a id="__codelineno-39-51" name="__codelineno-39-51" href="#__codelineno-39-51"></a><span class="s1">                USING DELTA</span>
</span><span id="__span-39-52"><a id="__codelineno-39-52" name="__codelineno-39-52" href="#__codelineno-39-52"></a><span class="s1">                PARTITIONED BY (age)</span>
</span><span id="__span-39-53"><a id="__codelineno-39-53" name="__codelineno-39-53" href="#__codelineno-39-53"></a><span class="s1">                TBLPROPERTIES (delta.enableChangeDataFeed = true)</span>
</span><span id="__span-39-54"><a id="__codelineno-39-54" name="__codelineno-39-54" href="#__codelineno-39-54"></a><span class="s1">                LOCATION &#39;</span><span class="si">{0}</span><span class="s1">&#39;</span>
</span><span id="__span-39-55"><a id="__codelineno-39-55" name="__codelineno-39-55" href="#__codelineno-39-55"></a><span class="s1">            &#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
</span><span id="__span-39-56"><a id="__codelineno-39-56" name="__codelineno-39-56" href="#__codelineno-39-56"></a>
</span><span id="__span-39-57"><a id="__codelineno-39-57" name="__codelineno-39-57" href="#__codelineno-39-57"></a>    <span class="n">spark</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> \
</span><span id="__span-39-58"><a id="__codelineno-39-58" name="__codelineno-39-58" href="#__codelineno-39-58"></a>        <span class="o">.</span><span class="n">selectExpr</span><span class="p">(</span>
</span><span id="__span-39-59"><a id="__codelineno-39-59" name="__codelineno-39-59" href="#__codelineno-39-59"></a>            <span class="s2">&quot;CAST(id as INT) as id&quot;</span><span class="p">,</span>
</span><span id="__span-39-60"><a id="__codelineno-39-60" name="__codelineno-39-60" href="#__codelineno-39-60"></a>            <span class="s2">&quot;CAST(id as STRING) as name&quot;</span><span class="p">,</span>
</span><span id="__span-39-61"><a id="__codelineno-39-61" name="__codelineno-39-61" href="#__codelineno-39-61"></a>            <span class="s2">&quot;CAST(id % 4 + 18 as INT) as age&quot;</span><span class="p">)</span> \
</span><span id="__span-39-62"><a id="__codelineno-39-62" name="__codelineno-39-62" href="#__codelineno-39-62"></a>        <span class="o">.</span><span class="n">write</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;delta&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mode</span><span class="p">(</span><span class="s2">&quot;append&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>  <span class="c1"># v1</span>
</span><span id="__span-39-63"><a id="__codelineno-39-63" name="__codelineno-39-63" href="#__codelineno-39-63"></a>
</span><span id="__span-39-64"><a id="__codelineno-39-64" name="__codelineno-39-64" href="#__codelineno-39-64"></a>    <span class="c1"># =============== Show table data + changes ===============</span>
</span><span id="__span-39-65"><a id="__codelineno-39-65" name="__codelineno-39-65" href="#__codelineno-39-65"></a>
</span><span id="__span-39-66"><a id="__codelineno-39-66" name="__codelineno-39-66" href="#__codelineno-39-66"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;(v1) Initial Table&quot;</span><span class="p">)</span>
</span><span id="__span-39-67"><a id="__codelineno-39-67" name="__codelineno-39-67" href="#__codelineno-39-67"></a>    <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;delta&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="__span-39-68"><a id="__codelineno-39-68" name="__codelineno-39-68" href="#__codelineno-39-68"></a>
</span><span id="__span-39-69"><a id="__codelineno-39-69" name="__codelineno-39-69" href="#__codelineno-39-69"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;(v1) CDC changes&quot;</span><span class="p">)</span>
</span><span id="__span-39-70"><a id="__codelineno-39-70" name="__codelineno-39-70" href="#__codelineno-39-70"></a>    <span class="n">read_cdc_by_table_name</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="__span-39-71"><a id="__codelineno-39-71" name="__codelineno-39-71" href="#__codelineno-39-71"></a>
</span><span id="__span-39-72"><a id="__codelineno-39-72" name="__codelineno-39-72" href="#__codelineno-39-72"></a>    <span class="n">table</span> <span class="o">=</span> <span class="n">DeltaTable</span><span class="o">.</span><span class="n">forPath</span><span class="p">(</span><span class="n">spark</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
</span><span id="__span-39-73"><a id="__codelineno-39-73" name="__codelineno-39-73" href="#__codelineno-39-73"></a>
</span><span id="__span-39-74"><a id="__codelineno-39-74" name="__codelineno-39-74" href="#__codelineno-39-74"></a>    <span class="c1"># =============== Perform UPDATE ===============</span>
</span><span id="__span-39-75"><a id="__codelineno-39-75" name="__codelineno-39-75" href="#__codelineno-39-75"></a>
</span><span id="__span-39-76"><a id="__codelineno-39-76" name="__codelineno-39-76" href="#__codelineno-39-76"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;(v2) Updated id -&gt; id + 1&quot;</span><span class="p">)</span>
</span><span id="__span-39-77"><a id="__codelineno-39-77" name="__codelineno-39-77" href="#__codelineno-39-77"></a>    <span class="n">table</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">set</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">expr</span><span class="p">(</span><span class="s2">&quot;id + 1&quot;</span><span class="p">)})</span>  <span class="c1"># v2</span>
</span><span id="__span-39-78"><a id="__codelineno-39-78" name="__codelineno-39-78" href="#__codelineno-39-78"></a>    <span class="n">read_cdc_by_table_name</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="__span-39-79"><a id="__codelineno-39-79" name="__codelineno-39-79" href="#__codelineno-39-79"></a>
</span><span id="__span-39-80"><a id="__codelineno-39-80" name="__codelineno-39-80" href="#__codelineno-39-80"></a>    <span class="c1"># =============== Perform DELETE ===============</span>
</span><span id="__span-39-81"><a id="__codelineno-39-81" name="__codelineno-39-81" href="#__codelineno-39-81"></a>
</span><span id="__span-39-82"><a id="__codelineno-39-82" name="__codelineno-39-82" href="#__codelineno-39-82"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;(v3) Deleted where id &gt;= 7&quot;</span><span class="p">)</span>
</span><span id="__span-39-83"><a id="__codelineno-39-83" name="__codelineno-39-83" href="#__codelineno-39-83"></a>    <span class="n">table</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">condition</span><span class="o">=</span><span class="n">expr</span><span class="p">(</span><span class="s2">&quot;id &gt;= 7&quot;</span><span class="p">))</span>  <span class="c1"># v3</span>
</span><span id="__span-39-84"><a id="__codelineno-39-84" name="__codelineno-39-84" href="#__codelineno-39-84"></a>    <span class="n">read_cdc_by_table_name</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="__span-39-85"><a id="__codelineno-39-85" name="__codelineno-39-85" href="#__codelineno-39-85"></a>
</span><span id="__span-39-86"><a id="__codelineno-39-86" name="__codelineno-39-86" href="#__codelineno-39-86"></a>    <span class="c1"># =============== Perform partition DELETE ===============</span>
</span><span id="__span-39-87"><a id="__codelineno-39-87" name="__codelineno-39-87" href="#__codelineno-39-87"></a>
</span><span id="__span-39-88"><a id="__codelineno-39-88" name="__codelineno-39-88" href="#__codelineno-39-88"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;(v4) Deleted where age = 18&quot;</span><span class="p">)</span>
</span><span id="__span-39-89"><a id="__codelineno-39-89" name="__codelineno-39-89" href="#__codelineno-39-89"></a>    <span class="n">table</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">condition</span><span class="o">=</span><span class="n">expr</span><span class="p">(</span><span class="s2">&quot;age = 18&quot;</span><span class="p">))</span>  <span class="c1"># v4, partition delete</span>
</span><span id="__span-39-90"><a id="__codelineno-39-90" name="__codelineno-39-90" href="#__codelineno-39-90"></a>    <span class="n">read_cdc_by_table_name</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="__span-39-91"><a id="__codelineno-39-91" name="__codelineno-39-91" href="#__codelineno-39-91"></a>
</span><span id="__span-39-92"><a id="__codelineno-39-92" name="__codelineno-39-92" href="#__codelineno-39-92"></a>    <span class="c1"># =============== Create source table for MERGE ===============</span>
</span><span id="__span-39-93"><a id="__codelineno-39-93" name="__codelineno-39-93" href="#__codelineno-39-93"></a>
</span><span id="__span-39-94"><a id="__codelineno-39-94" name="__codelineno-39-94" href="#__codelineno-39-94"></a>    <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;CREATE TABLE student_source (id INT, name STRING, age INT)</span>
</span><span id="__span-39-95"><a id="__codelineno-39-95" name="__codelineno-39-95" href="#__codelineno-39-95"></a><span class="s1">                USING DELTA</span>
</span><span id="__span-39-96"><a id="__codelineno-39-96" name="__codelineno-39-96" href="#__codelineno-39-96"></a><span class="s1">                LOCATION &#39;</span><span class="si">{0}</span><span class="s1">&#39;</span>
</span><span id="__span-39-97"><a id="__codelineno-39-97" name="__codelineno-39-97" href="#__codelineno-39-97"></a><span class="s1">            &#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">otherPath</span><span class="p">))</span>
</span><span id="__span-39-98"><a id="__codelineno-39-98" name="__codelineno-39-98" href="#__codelineno-39-98"></a>    <span class="n">spark</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> \
</span><span id="__span-39-99"><a id="__codelineno-39-99" name="__codelineno-39-99" href="#__codelineno-39-99"></a>        <span class="o">.</span><span class="n">selectExpr</span><span class="p">(</span>
</span><span id="__span-39-100"><a id="__codelineno-39-100" name="__codelineno-39-100" href="#__codelineno-39-100"></a>            <span class="s2">&quot;CAST(id as INT) as id&quot;</span><span class="p">,</span>
</span><span id="__span-39-101"><a id="__codelineno-39-101" name="__codelineno-39-101" href="#__codelineno-39-101"></a>            <span class="s2">&quot;CAST(id as STRING) as name&quot;</span><span class="p">,</span>
</span><span id="__span-39-102"><a id="__codelineno-39-102" name="__codelineno-39-102" href="#__codelineno-39-102"></a>            <span class="s2">&quot;CAST(id % 4 + 18 as INT) as age&quot;</span><span class="p">)</span> \
</span><span id="__span-39-103"><a id="__codelineno-39-103" name="__codelineno-39-103" href="#__codelineno-39-103"></a>        <span class="o">.</span><span class="n">write</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;delta&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mode</span><span class="p">(</span><span class="s2">&quot;append&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">saveAsTable</span><span class="p">(</span><span class="s2">&quot;student_source&quot;</span><span class="p">)</span>
</span><span id="__span-39-104"><a id="__codelineno-39-104" name="__codelineno-39-104" href="#__codelineno-39-104"></a>    <span class="n">source</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM student_source&quot;</span><span class="p">)</span>
</span><span id="__span-39-105"><a id="__codelineno-39-105" name="__codelineno-39-105" href="#__codelineno-39-105"></a>
</span><span id="__span-39-106"><a id="__codelineno-39-106" name="__codelineno-39-106" href="#__codelineno-39-106"></a>    <span class="c1"># =============== Perform MERGE ===============</span>
</span><span id="__span-39-107"><a id="__codelineno-39-107" name="__codelineno-39-107" href="#__codelineno-39-107"></a>
</span><span id="__span-39-108"><a id="__codelineno-39-108" name="__codelineno-39-108" href="#__codelineno-39-108"></a>    <span class="n">table</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;target&quot;</span><span class="p">)</span> \
</span><span id="__span-39-109"><a id="__codelineno-39-109" name="__codelineno-39-109" href="#__codelineno-39-109"></a>        <span class="o">.</span><span class="n">merge</span><span class="p">(</span>
</span><span id="__span-39-110"><a id="__codelineno-39-110" name="__codelineno-39-110" href="#__codelineno-39-110"></a>            <span class="n">source</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;source&quot;</span><span class="p">),</span>
</span><span id="__span-39-111"><a id="__codelineno-39-111" name="__codelineno-39-111" href="#__codelineno-39-111"></a>            <span class="s2">&quot;target.id = source.id&quot;</span><span class="p">)</span>\
</span><span id="__span-39-112"><a id="__codelineno-39-112" name="__codelineno-39-112" href="#__codelineno-39-112"></a>        <span class="o">.</span><span class="n">whenMatchedUpdate</span><span class="p">(</span><span class="nb">set</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;source.id&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="s2">&quot;source.age + 10&quot;</span><span class="p">})</span> \
</span><span id="__span-39-113"><a id="__codelineno-39-113" name="__codelineno-39-113" href="#__codelineno-39-113"></a>        <span class="o">.</span><span class="n">whenNotMatchedInsertAll</span><span class="p">()</span> \
</span><span id="__span-39-114"><a id="__codelineno-39-114" name="__codelineno-39-114" href="#__codelineno-39-114"></a>        <span class="o">.</span><span class="n">execute</span><span class="p">()</span> <span class="c1"># v5</span>
</span><span id="__span-39-115"><a id="__codelineno-39-115" name="__codelineno-39-115" href="#__codelineno-39-115"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;(v5) Merged with a source table&quot;</span><span class="p">)</span>
</span><span id="__span-39-116"><a id="__codelineno-39-116" name="__codelineno-39-116" href="#__codelineno-39-116"></a>    <span class="n">read_cdc_by_table_name</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="__span-39-117"><a id="__codelineno-39-117" name="__codelineno-39-117" href="#__codelineno-39-117"></a>
</span><span id="__span-39-118"><a id="__codelineno-39-118" name="__codelineno-39-118" href="#__codelineno-39-118"></a>    <span class="c1"># =============== Stream changes ===============</span>
</span><span id="__span-39-119"><a id="__codelineno-39-119" name="__codelineno-39-119" href="#__codelineno-39-119"></a>
</span><span id="__span-39-120"><a id="__codelineno-39-120" name="__codelineno-39-120" href="#__codelineno-39-120"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Streaming by table name&quot;</span><span class="p">)</span>
</span><span id="__span-39-121"><a id="__codelineno-39-121" name="__codelineno-39-121" href="#__codelineno-39-121"></a>    <span class="n">cdfStream</span> <span class="o">=</span> <span class="n">stream_cdc_by_table_name</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-39-122"><a id="__codelineno-39-122" name="__codelineno-39-122" href="#__codelineno-39-122"></a>    <span class="n">cdfStream</span><span class="o">.</span><span class="n">awaitTermination</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</span><span id="__span-39-123"><a id="__codelineno-39-123" name="__codelineno-39-123" href="#__codelineno-39-123"></a>    <span class="n">cdfStream</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
</span><span id="__span-39-124"><a id="__codelineno-39-124" name="__codelineno-39-124" href="#__codelineno-39-124"></a>
</span><span id="__span-39-125"><a id="__codelineno-39-125" name="__codelineno-39-125" href="#__codelineno-39-125"></a><span class="k">finally</span><span class="p">:</span>
</span><span id="__span-39-126"><a id="__codelineno-39-126" name="__codelineno-39-126" href="#__codelineno-39-126"></a>    <span class="n">cleanup</span><span class="p">()</span>
</span><span id="__span-39-127"><a id="__codelineno-39-127" name="__codelineno-39-127" href="#__codelineno-39-127"></a>    <span class="n">spark</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
</span></code></pre></div>
<p>It will do some steps:</p>
<ul>
<li>create student table</li>
<li>show table data and all the changes</li>
<li>perform any <code>UPDATE</code></li>
<li>perform <code>DELETE</code></li>
<li>perform partition <code>DELETE</code></li>
<li>create source table for <code>MERGE</code></li>
<li>perform <code>MERGE</code></li>
<li>Stream changes</li>
</ul>
<p>to run the code, simply run below command</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-40-1"><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a>./bin/spark-submit<span class="w"> </span>scripts/delta-cdc.py
</span></code></pre></div>
<p>Output:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-41-1"><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a>-------------------------------------------
</span><span id="__span-41-2"><a id="__codelineno-41-2" name="__codelineno-41-2" href="#__codelineno-41-2"></a>Batch:<span class="w"> </span><span class="m">0</span>
</span><span id="__span-41-3"><a id="__codelineno-41-3" name="__codelineno-41-3" href="#__codelineno-41-3"></a>-------------------------------------------
</span><span id="__span-41-4"><a id="__codelineno-41-4" name="__codelineno-41-4" href="#__codelineno-41-4"></a><span class="m">24</span>/07/02<span class="w"> </span><span class="m">07</span>:59:49<span class="w"> </span>INFO<span class="w"> </span>CodeGenerator:<span class="w"> </span>Code<span class="w"> </span>generated<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">1</span>.676625<span class="w"> </span>ms
</span><span id="__span-41-5"><a id="__codelineno-41-5" name="__codelineno-41-5" href="#__codelineno-41-5"></a>+---+----+---+----------------+---------------+--------------------+
</span><span id="__span-41-6"><a id="__codelineno-41-6" name="__codelineno-41-6" href="#__codelineno-41-6"></a><span class="p">|</span><span class="w"> </span>id<span class="p">|</span>name<span class="p">|</span>age<span class="p">|</span><span class="w">    </span>_change_type<span class="p">|</span>_commit_version<span class="p">|</span><span class="w">   </span>_commit_timestamp<span class="p">|</span>
</span><span id="__span-41-7"><a id="__codelineno-41-7" name="__codelineno-41-7" href="#__codelineno-41-7"></a>+---+----+---+----------------+---------------+--------------------+
</span><span id="__span-41-8"><a id="__codelineno-41-8" name="__codelineno-41-8" href="#__codelineno-41-8"></a><span class="p">|</span><span class="w">  </span><span class="m">6</span><span class="p">|</span><span class="w">   </span><span class="m">6</span><span class="p">|</span><span class="w"> </span><span class="m">20</span><span class="p">|</span><span class="w"> </span>update_preimage<span class="p">|</span><span class="w">              </span><span class="m">2</span><span class="p">|</span><span class="m">2024</span>-07-02<span class="w"> </span><span class="m">07</span>:59:...<span class="p">|</span>
</span><span id="__span-41-9"><a id="__codelineno-41-9" name="__codelineno-41-9" href="#__codelineno-41-9"></a><span class="p">|</span><span class="w">  </span><span class="m">7</span><span class="p">|</span><span class="w">   </span><span class="m">6</span><span class="p">|</span><span class="w"> </span><span class="m">20</span><span class="p">|</span>update_postimage<span class="p">|</span><span class="w">              </span><span class="m">2</span><span class="p">|</span><span class="m">2024</span>-07-02<span class="w"> </span><span class="m">07</span>:59:...<span class="p">|</span>
</span><span id="__span-41-10"><a id="__codelineno-41-10" name="__codelineno-41-10" href="#__codelineno-41-10"></a><span class="p">|</span><span class="w">  </span><span class="m">2</span><span class="p">|</span><span class="w">   </span><span class="m">2</span><span class="p">|</span><span class="w"> </span><span class="m">20</span><span class="p">|</span><span class="w"> </span>update_preimage<span class="p">|</span><span class="w">              </span><span class="m">2</span><span class="p">|</span><span class="m">2024</span>-07-02<span class="w"> </span><span class="m">07</span>:59:...<span class="p">|</span>
</span><span id="__span-41-11"><a id="__codelineno-41-11" name="__codelineno-41-11" href="#__codelineno-41-11"></a><span class="p">|</span><span class="w">  </span><span class="m">3</span><span class="p">|</span><span class="w">   </span><span class="m">2</span><span class="p">|</span><span class="w"> </span><span class="m">20</span><span class="p">|</span>update_postimage<span class="p">|</span><span class="w">              </span><span class="m">2</span><span class="p">|</span><span class="m">2024</span>-07-02<span class="w"> </span><span class="m">07</span>:59:...<span class="p">|</span>
</span><span id="__span-41-12"><a id="__codelineno-41-12" name="__codelineno-41-12" href="#__codelineno-41-12"></a><span class="p">|</span><span class="w">  </span><span class="m">8</span><span class="p">|</span><span class="w">   </span><span class="m">8</span><span class="p">|</span><span class="w"> </span><span class="m">18</span><span class="p">|</span><span class="w"> </span>update_preimage<span class="p">|</span><span class="w">              </span><span class="m">2</span><span class="p">|</span><span class="m">2024</span>-07-02<span class="w"> </span><span class="m">07</span>:59:...<span class="p">|</span>
</span><span id="__span-41-13"><a id="__codelineno-41-13" name="__codelineno-41-13" href="#__codelineno-41-13"></a><span class="p">|</span><span class="w">  </span><span class="m">9</span><span class="p">|</span><span class="w">   </span><span class="m">8</span><span class="p">|</span><span class="w"> </span><span class="m">18</span><span class="p">|</span>update_postimage<span class="p">|</span><span class="w">              </span><span class="m">2</span><span class="p">|</span><span class="m">2024</span>-07-02<span class="w"> </span><span class="m">07</span>:59:...<span class="p">|</span>
</span><span id="__span-41-14"><a id="__codelineno-41-14" name="__codelineno-41-14" href="#__codelineno-41-14"></a><span class="p">|</span><span class="w">  </span><span class="m">4</span><span class="p">|</span><span class="w">   </span><span class="m">4</span><span class="p">|</span><span class="w"> </span><span class="m">18</span><span class="p">|</span><span class="w"> </span>update_preimage<span class="p">|</span><span class="w">              </span><span class="m">2</span><span class="p">|</span><span class="m">2024</span>-07-02<span class="w"> </span><span class="m">07</span>:59:...<span class="p">|</span>
</span><span id="__span-41-15"><a id="__codelineno-41-15" name="__codelineno-41-15" href="#__codelineno-41-15"></a><span class="p">|</span><span class="w">  </span><span class="m">5</span><span class="p">|</span><span class="w">   </span><span class="m">4</span><span class="p">|</span><span class="w"> </span><span class="m">18</span><span class="p">|</span>update_postimage<span class="p">|</span><span class="w">              </span><span class="m">2</span><span class="p">|</span><span class="m">2024</span>-07-02<span class="w"> </span><span class="m">07</span>:59:...<span class="p">|</span>
</span><span id="__span-41-16"><a id="__codelineno-41-16" name="__codelineno-41-16" href="#__codelineno-41-16"></a><span class="p">|</span><span class="w">  </span><span class="m">1</span><span class="p">|</span><span class="w">   </span><span class="m">1</span><span class="p">|</span><span class="w"> </span><span class="m">19</span><span class="p">|</span><span class="w"> </span>update_preimage<span class="p">|</span><span class="w">              </span><span class="m">2</span><span class="p">|</span><span class="m">2024</span>-07-02<span class="w"> </span><span class="m">07</span>:59:...<span class="p">|</span>
</span><span id="__span-41-17"><a id="__codelineno-41-17" name="__codelineno-41-17" href="#__codelineno-41-17"></a><span class="p">|</span><span class="w">  </span><span class="m">2</span><span class="p">|</span><span class="w">   </span><span class="m">1</span><span class="p">|</span><span class="w"> </span><span class="m">19</span><span class="p">|</span>update_postimage<span class="p">|</span><span class="w">              </span><span class="m">2</span><span class="p">|</span><span class="m">2024</span>-07-02<span class="w"> </span><span class="m">07</span>:59:...<span class="p">|</span>
</span><span id="__span-41-18"><a id="__codelineno-41-18" name="__codelineno-41-18" href="#__codelineno-41-18"></a><span class="p">|</span><span class="w">  </span><span class="m">5</span><span class="p">|</span><span class="w">   </span><span class="m">5</span><span class="p">|</span><span class="w"> </span><span class="m">19</span><span class="p">|</span><span class="w"> </span>update_preimage<span class="p">|</span><span class="w">              </span><span class="m">2</span><span class="p">|</span><span class="m">2024</span>-07-02<span class="w"> </span><span class="m">07</span>:59:...<span class="p">|</span>
</span><span id="__span-41-19"><a id="__codelineno-41-19" name="__codelineno-41-19" href="#__codelineno-41-19"></a><span class="p">|</span><span class="w">  </span><span class="m">6</span><span class="p">|</span><span class="w">   </span><span class="m">5</span><span class="p">|</span><span class="w"> </span><span class="m">19</span><span class="p">|</span>update_postimage<span class="p">|</span><span class="w">              </span><span class="m">2</span><span class="p">|</span><span class="m">2024</span>-07-02<span class="w"> </span><span class="m">07</span>:59:...<span class="p">|</span>
</span><span id="__span-41-20"><a id="__codelineno-41-20" name="__codelineno-41-20" href="#__codelineno-41-20"></a><span class="p">|</span><span class="w">  </span><span class="m">9</span><span class="p">|</span><span class="w">   </span><span class="m">9</span><span class="p">|</span><span class="w"> </span><span class="m">19</span><span class="p">|</span><span class="w"> </span>update_preimage<span class="p">|</span><span class="w">              </span><span class="m">2</span><span class="p">|</span><span class="m">2024</span>-07-02<span class="w"> </span><span class="m">07</span>:59:...<span class="p">|</span>
</span><span id="__span-41-21"><a id="__codelineno-41-21" name="__codelineno-41-21" href="#__codelineno-41-21"></a><span class="p">|</span><span class="w"> </span><span class="m">10</span><span class="p">|</span><span class="w">   </span><span class="m">9</span><span class="p">|</span><span class="w"> </span><span class="m">19</span><span class="p">|</span>update_postimage<span class="p">|</span><span class="w">              </span><span class="m">2</span><span class="p">|</span><span class="m">2024</span>-07-02<span class="w"> </span><span class="m">07</span>:59:...<span class="p">|</span>
</span><span id="__span-41-22"><a id="__codelineno-41-22" name="__codelineno-41-22" href="#__codelineno-41-22"></a><span class="p">|</span><span class="w">  </span><span class="m">7</span><span class="p">|</span><span class="w">   </span><span class="m">7</span><span class="p">|</span><span class="w"> </span><span class="m">21</span><span class="p">|</span><span class="w"> </span>update_preimage<span class="p">|</span><span class="w">              </span><span class="m">2</span><span class="p">|</span><span class="m">2024</span>-07-02<span class="w"> </span><span class="m">07</span>:59:...<span class="p">|</span>
</span><span id="__span-41-23"><a id="__codelineno-41-23" name="__codelineno-41-23" href="#__codelineno-41-23"></a><span class="p">|</span><span class="w">  </span><span class="m">8</span><span class="p">|</span><span class="w">   </span><span class="m">7</span><span class="p">|</span><span class="w"> </span><span class="m">21</span><span class="p">|</span>update_postimage<span class="p">|</span><span class="w">              </span><span class="m">2</span><span class="p">|</span><span class="m">2024</span>-07-02<span class="w"> </span><span class="m">07</span>:59:...<span class="p">|</span>
</span><span id="__span-41-24"><a id="__codelineno-41-24" name="__codelineno-41-24" href="#__codelineno-41-24"></a><span class="p">|</span><span class="w">  </span><span class="m">3</span><span class="p">|</span><span class="w">   </span><span class="m">3</span><span class="p">|</span><span class="w"> </span><span class="m">21</span><span class="p">|</span><span class="w"> </span>update_preimage<span class="p">|</span><span class="w">              </span><span class="m">2</span><span class="p">|</span><span class="m">2024</span>-07-02<span class="w"> </span><span class="m">07</span>:59:...<span class="p">|</span>
</span><span id="__span-41-25"><a id="__codelineno-41-25" name="__codelineno-41-25" href="#__codelineno-41-25"></a><span class="p">|</span><span class="w">  </span><span class="m">4</span><span class="p">|</span><span class="w">   </span><span class="m">3</span><span class="p">|</span><span class="w"> </span><span class="m">21</span><span class="p">|</span>update_postimage<span class="p">|</span><span class="w">              </span><span class="m">2</span><span class="p">|</span><span class="m">2024</span>-07-02<span class="w"> </span><span class="m">07</span>:59:...<span class="p">|</span>
</span><span id="__span-41-26"><a id="__codelineno-41-26" name="__codelineno-41-26" href="#__codelineno-41-26"></a><span class="p">|</span><span class="w">  </span><span class="m">0</span><span class="p">|</span><span class="w">   </span><span class="m">0</span><span class="p">|</span><span class="w"> </span><span class="m">18</span><span class="p">|</span><span class="w"> </span>update_preimage<span class="p">|</span><span class="w">              </span><span class="m">2</span><span class="p">|</span><span class="m">2024</span>-07-02<span class="w"> </span><span class="m">07</span>:59:...<span class="p">|</span>
</span><span id="__span-41-27"><a id="__codelineno-41-27" name="__codelineno-41-27" href="#__codelineno-41-27"></a><span class="p">|</span><span class="w">  </span><span class="m">1</span><span class="p">|</span><span class="w">   </span><span class="m">0</span><span class="p">|</span><span class="w"> </span><span class="m">18</span><span class="p">|</span>update_postimage<span class="p">|</span><span class="w">              </span><span class="m">2</span><span class="p">|</span><span class="m">2024</span>-07-02<span class="w"> </span><span class="m">07</span>:59:...<span class="p">|</span>
</span><span id="__span-41-28"><a id="__codelineno-41-28" name="__codelineno-41-28" href="#__codelineno-41-28"></a><span class="p">|</span><span class="w">  </span><span class="m">2</span><span class="p">|</span><span class="w">   </span><span class="m">1</span><span class="p">|</span><span class="w"> </span><span class="m">30</span><span class="p">|</span>update_postimage<span class="p">|</span><span class="w">              </span><span class="m">5</span><span class="p">|</span><span class="m">2024</span>-07-02<span class="w"> </span><span class="m">07</span>:59:...<span class="p">|</span>
</span><span id="__span-41-29"><a id="__codelineno-41-29" name="__codelineno-41-29" href="#__codelineno-41-29"></a><span class="p">|</span><span class="w">  </span><span class="m">1</span><span class="p">|</span><span class="w">   </span><span class="m">1</span><span class="p">|</span><span class="w"> </span><span class="m">19</span><span class="p">|</span><span class="w">          </span>insert<span class="p">|</span><span class="w">              </span><span class="m">5</span><span class="p">|</span><span class="m">2024</span>-07-02<span class="w"> </span><span class="m">07</span>:59:...<span class="p">|</span>
</span><span id="__span-41-30"><a id="__codelineno-41-30" name="__codelineno-41-30" href="#__codelineno-41-30"></a><span class="p">|</span><span class="w">  </span><span class="m">2</span><span class="p">|</span><span class="w">   </span><span class="m">1</span><span class="p">|</span><span class="w"> </span><span class="m">19</span><span class="p">|</span><span class="w"> </span>update_preimage<span class="p">|</span><span class="w">              </span><span class="m">5</span><span class="p">|</span><span class="m">2024</span>-07-02<span class="w"> </span><span class="m">07</span>:59:...<span class="p">|</span>
</span><span id="__span-41-31"><a id="__codelineno-41-31" name="__codelineno-41-31" href="#__codelineno-41-31"></a><span class="p">|</span><span class="w"> </span><span class="m">10</span><span class="p">|</span><span class="w">   </span><span class="m">9</span><span class="p">|</span><span class="w"> </span><span class="m">19</span><span class="p">|</span><span class="w">          </span>delete<span class="p">|</span><span class="w">              </span><span class="m">3</span><span class="p">|</span><span class="m">2024</span>-07-02<span class="w"> </span><span class="m">07</span>:59:...<span class="p">|</span>
</span><span id="__span-41-32"><a id="__codelineno-41-32" name="__codelineno-41-32" href="#__codelineno-41-32"></a><span class="p">|</span><span class="w">  </span><span class="m">7</span><span class="p">|</span><span class="w">   </span><span class="m">6</span><span class="p">|</span><span class="w"> </span><span class="m">20</span><span class="p">|</span><span class="w">          </span>delete<span class="p">|</span><span class="w">              </span><span class="m">3</span><span class="p">|</span><span class="m">2024</span>-07-02<span class="w"> </span><span class="m">07</span>:59:...<span class="p">|</span>
</span><span id="__span-41-33"><a id="__codelineno-41-33" name="__codelineno-41-33" href="#__codelineno-41-33"></a><span class="p">|</span><span class="w">  </span><span class="m">0</span><span class="p">|</span><span class="w">   </span><span class="m">0</span><span class="p">|</span><span class="w"> </span><span class="m">18</span><span class="p">|</span><span class="w">          </span>insert<span class="p">|</span><span class="w">              </span><span class="m">5</span><span class="p">|</span><span class="m">2024</span>-07-02<span class="w"> </span><span class="m">07</span>:59:...<span class="p">|</span>
</span><span id="__span-41-34"><a id="__codelineno-41-34" name="__codelineno-41-34" href="#__codelineno-41-34"></a><span class="p">|</span><span class="w">  </span><span class="m">8</span><span class="p">|</span><span class="w">   </span><span class="m">7</span><span class="p">|</span><span class="w"> </span><span class="m">21</span><span class="p">|</span><span class="w">          </span>delete<span class="p">|</span><span class="w">              </span><span class="m">3</span><span class="p">|</span><span class="m">2024</span>-07-02<span class="w"> </span><span class="m">07</span>:59:...<span class="p">|</span>
</span><span id="__span-41-35"><a id="__codelineno-41-35" name="__codelineno-41-35" href="#__codelineno-41-35"></a><span class="p">|</span><span class="w">  </span><span class="m">9</span><span class="p">|</span><span class="w">   </span><span class="m">8</span><span class="p">|</span><span class="w"> </span><span class="m">18</span><span class="p">|</span><span class="w">          </span>delete<span class="p">|</span><span class="w">              </span><span class="m">3</span><span class="p">|</span><span class="m">2024</span>-07-02<span class="w"> </span><span class="m">07</span>:59:...<span class="p">|</span>
</span><span id="__span-41-36"><a id="__codelineno-41-36" name="__codelineno-41-36" href="#__codelineno-41-36"></a><span class="p">|</span><span class="w">  </span><span class="m">0</span><span class="p">|</span><span class="w">   </span><span class="m">0</span><span class="p">|</span><span class="w"> </span><span class="m">18</span><span class="p">|</span><span class="w">          </span>insert<span class="p">|</span><span class="w">              </span><span class="m">1</span><span class="p">|</span><span class="m">2024</span>-07-02<span class="w"> </span><span class="m">07</span>:59:...<span class="p">|</span>
</span><span id="__span-41-37"><a id="__codelineno-41-37" name="__codelineno-41-37" href="#__codelineno-41-37"></a><span class="p">|</span><span class="w">  </span><span class="m">8</span><span class="p">|</span><span class="w">   </span><span class="m">8</span><span class="p">|</span><span class="w"> </span><span class="m">18</span><span class="p">|</span><span class="w">          </span>insert<span class="p">|</span><span class="w">              </span><span class="m">1</span><span class="p">|</span><span class="m">2024</span>-07-02<span class="w"> </span><span class="m">07</span>:59:...<span class="p">|</span>
</span><span id="__span-41-38"><a id="__codelineno-41-38" name="__codelineno-41-38" href="#__codelineno-41-38"></a><span class="p">|</span><span class="w">  </span><span class="m">4</span><span class="p">|</span><span class="w">   </span><span class="m">4</span><span class="p">|</span><span class="w"> </span><span class="m">18</span><span class="p">|</span><span class="w">          </span>insert<span class="p">|</span><span class="w">              </span><span class="m">1</span><span class="p">|</span><span class="m">2024</span>-07-02<span class="w"> </span><span class="m">07</span>:59:...<span class="p">|</span>
</span><span id="__span-41-39"><a id="__codelineno-41-39" name="__codelineno-41-39" href="#__codelineno-41-39"></a><span class="p">|</span><span class="w">  </span><span class="m">3</span><span class="p">|</span><span class="w">   </span><span class="m">3</span><span class="p">|</span><span class="w"> </span><span class="m">21</span><span class="p">|</span><span class="w">          </span>insert<span class="p">|</span><span class="w">              </span><span class="m">1</span><span class="p">|</span><span class="m">2024</span>-07-02<span class="w"> </span><span class="m">07</span>:59:...<span class="p">|</span>
</span><span id="__span-41-40"><a id="__codelineno-41-40" name="__codelineno-41-40" href="#__codelineno-41-40"></a><span class="p">|</span><span class="w">  </span><span class="m">7</span><span class="p">|</span><span class="w">   </span><span class="m">7</span><span class="p">|</span><span class="w"> </span><span class="m">21</span><span class="p">|</span><span class="w">          </span>insert<span class="p">|</span><span class="w">              </span><span class="m">1</span><span class="p">|</span><span class="m">2024</span>-07-02<span class="w"> </span><span class="m">07</span>:59:...<span class="p">|</span>
</span><span id="__span-41-41"><a id="__codelineno-41-41" name="__codelineno-41-41" href="#__codelineno-41-41"></a><span class="p">|</span><span class="w">  </span><span class="m">1</span><span class="p">|</span><span class="w">   </span><span class="m">1</span><span class="p">|</span><span class="w"> </span><span class="m">19</span><span class="p">|</span><span class="w">          </span>insert<span class="p">|</span><span class="w">              </span><span class="m">1</span><span class="p">|</span><span class="m">2024</span>-07-02<span class="w"> </span><span class="m">07</span>:59:...<span class="p">|</span>
</span><span id="__span-41-42"><a id="__codelineno-41-42" name="__codelineno-41-42" href="#__codelineno-41-42"></a><span class="p">|</span><span class="w">  </span><span class="m">5</span><span class="p">|</span><span class="w">   </span><span class="m">5</span><span class="p">|</span><span class="w"> </span><span class="m">19</span><span class="p">|</span><span class="w">          </span>insert<span class="p">|</span><span class="w">              </span><span class="m">1</span><span class="p">|</span><span class="m">2024</span>-07-02<span class="w"> </span><span class="m">07</span>:59:...<span class="p">|</span>
</span><span id="__span-41-43"><a id="__codelineno-41-43" name="__codelineno-41-43" href="#__codelineno-41-43"></a><span class="p">|</span><span class="w">  </span><span class="m">9</span><span class="p">|</span><span class="w">   </span><span class="m">9</span><span class="p">|</span><span class="w"> </span><span class="m">19</span><span class="p">|</span><span class="w">          </span>insert<span class="p">|</span><span class="w">              </span><span class="m">1</span><span class="p">|</span><span class="m">2024</span>-07-02<span class="w"> </span><span class="m">07</span>:59:...<span class="p">|</span>
</span><span id="__span-41-44"><a id="__codelineno-41-44" name="__codelineno-41-44" href="#__codelineno-41-44"></a><span class="p">|</span><span class="w">  </span><span class="m">6</span><span class="p">|</span><span class="w">   </span><span class="m">6</span><span class="p">|</span><span class="w"> </span><span class="m">20</span><span class="p">|</span><span class="w">          </span>insert<span class="p">|</span><span class="w">              </span><span class="m">1</span><span class="p">|</span><span class="m">2024</span>-07-02<span class="w"> </span><span class="m">07</span>:59:...<span class="p">|</span>
</span><span id="__span-41-45"><a id="__codelineno-41-45" name="__codelineno-41-45" href="#__codelineno-41-45"></a><span class="p">|</span><span class="w">  </span><span class="m">2</span><span class="p">|</span><span class="w">   </span><span class="m">2</span><span class="p">|</span><span class="w"> </span><span class="m">20</span><span class="p">|</span><span class="w">          </span>insert<span class="p">|</span><span class="w">              </span><span class="m">1</span><span class="p">|</span><span class="m">2024</span>-07-02<span class="w"> </span><span class="m">07</span>:59:...<span class="p">|</span>
</span><span id="__span-41-46"><a id="__codelineno-41-46" name="__codelineno-41-46" href="#__codelineno-41-46"></a><span class="p">|</span><span class="w">  </span><span class="m">1</span><span class="p">|</span><span class="w">   </span><span class="m">0</span><span class="p">|</span><span class="w"> </span><span class="m">18</span><span class="p">|</span><span class="w">          </span>delete<span class="p">|</span><span class="w">              </span><span class="m">4</span><span class="p">|</span><span class="m">2024</span>-07-02<span class="w"> </span><span class="m">07</span>:59:...<span class="p">|</span>
</span><span id="__span-41-47"><a id="__codelineno-41-47" name="__codelineno-41-47" href="#__codelineno-41-47"></a><span class="p">|</span><span class="w">  </span><span class="m">5</span><span class="p">|</span><span class="w">   </span><span class="m">4</span><span class="p">|</span><span class="w"> </span><span class="m">18</span><span class="p">|</span><span class="w">          </span>delete<span class="p">|</span><span class="w">              </span><span class="m">4</span><span class="p">|</span><span class="m">2024</span>-07-02<span class="w"> </span><span class="m">07</span>:59:...<span class="p">|</span>
</span><span id="__span-41-48"><a id="__codelineno-41-48" name="__codelineno-41-48" href="#__codelineno-41-48"></a>+---+----+---+----------------+---------------+--------------------+
</span></code></pre></div>
<p>The latest status</p>
<div class="language-json highlight"><pre><span></span><code><span id="__span-42-1"><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a><span class="mi">24</span><span class="err">/</span><span class="mi">07</span><span class="err">/</span><span class="mi">02</span><span class="w"> </span><span class="mi">07</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">49</span><span class="w"> </span><span class="err">INFO</span><span class="w"> </span><span class="err">MicroBa</span><span class="kc">t</span><span class="err">chExecu</span><span class="kc">t</span><span class="err">io</span><span class="kc">n</span><span class="p">:</span><span class="w"> </span><span class="err">S</span><span class="kc">trea</span><span class="err">mi</span><span class="kc">n</span><span class="err">g</span><span class="w"> </span><span class="err">query</span><span class="w"> </span><span class="err">made</span><span class="w"> </span><span class="err">progress</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-42-2"><a id="__codelineno-42-2" name="__codelineno-42-2" href="#__codelineno-42-2"></a><span class="w">  </span><span class="nt">&quot;id&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;b8eae84d-c996-4b17-aeca-84fbbe5afe7e&quot;</span><span class="p">,</span>
</span><span id="__span-42-3"><a id="__codelineno-42-3" name="__codelineno-42-3" href="#__codelineno-42-3"></a><span class="w">  </span><span class="nt">&quot;runId&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;987c4c3e-76c6-48be-b755-3b888297c183&quot;</span><span class="p">,</span>
</span><span id="__span-42-4"><a id="__codelineno-42-4" name="__codelineno-42-4" href="#__codelineno-42-4"></a><span class="w">  </span><span class="nt">&quot;name&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span>
</span><span id="__span-42-5"><a id="__codelineno-42-5" name="__codelineno-42-5" href="#__codelineno-42-5"></a><span class="w">  </span><span class="nt">&quot;timestamp&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2024-07-02T07:59:49.387Z&quot;</span><span class="p">,</span>
</span><span id="__span-42-6"><a id="__codelineno-42-6" name="__codelineno-42-6" href="#__codelineno-42-6"></a><span class="w">  </span><span class="nt">&quot;batchId&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
</span><span id="__span-42-7"><a id="__codelineno-42-7" name="__codelineno-42-7" href="#__codelineno-42-7"></a><span class="w">  </span><span class="nt">&quot;numInputRows&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">40</span><span class="p">,</span>
</span><span id="__span-42-8"><a id="__codelineno-42-8" name="__codelineno-42-8" href="#__codelineno-42-8"></a><span class="w">  </span><span class="nt">&quot;inputRowsPerSecond&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span>
</span><span id="__span-42-9"><a id="__codelineno-42-9" name="__codelineno-42-9" href="#__codelineno-42-9"></a><span class="w">  </span><span class="nt">&quot;processedRowsPerSecond&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mf">90.29345372460496</span><span class="p">,</span>
</span><span id="__span-42-10"><a id="__codelineno-42-10" name="__codelineno-42-10" href="#__codelineno-42-10"></a><span class="w">  </span><span class="nt">&quot;durationMs&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-42-11"><a id="__codelineno-42-11" name="__codelineno-42-11" href="#__codelineno-42-11"></a><span class="w">    </span><span class="nt">&quot;addBatch&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">182</span><span class="p">,</span>
</span><span id="__span-42-12"><a id="__codelineno-42-12" name="__codelineno-42-12" href="#__codelineno-42-12"></a><span class="w">    </span><span class="nt">&quot;commitOffsets&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">12</span><span class="p">,</span>
</span><span id="__span-42-13"><a id="__codelineno-42-13" name="__codelineno-42-13" href="#__codelineno-42-13"></a><span class="w">    </span><span class="nt">&quot;getBatch&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">55</span><span class="p">,</span>
</span><span id="__span-42-14"><a id="__codelineno-42-14" name="__codelineno-42-14" href="#__codelineno-42-14"></a><span class="w">    </span><span class="nt">&quot;latestOffset&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">115</span><span class="p">,</span>
</span><span id="__span-42-15"><a id="__codelineno-42-15" name="__codelineno-42-15" href="#__codelineno-42-15"></a><span class="w">    </span><span class="nt">&quot;queryPlanning&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">44</span><span class="p">,</span>
</span><span id="__span-42-16"><a id="__codelineno-42-16" name="__codelineno-42-16" href="#__codelineno-42-16"></a><span class="w">    </span><span class="nt">&quot;triggerExecution&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">443</span><span class="p">,</span>
</span><span id="__span-42-17"><a id="__codelineno-42-17" name="__codelineno-42-17" href="#__codelineno-42-17"></a><span class="w">    </span><span class="nt">&quot;walCommit&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">24</span>
</span><span id="__span-42-18"><a id="__codelineno-42-18" name="__codelineno-42-18" href="#__codelineno-42-18"></a><span class="w">  </span><span class="p">},</span>
</span><span id="__span-42-19"><a id="__codelineno-42-19" name="__codelineno-42-19" href="#__codelineno-42-19"></a><span class="w">  </span><span class="nt">&quot;stateOperators&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="p">],</span>
</span><span id="__span-42-20"><a id="__codelineno-42-20" name="__codelineno-42-20" href="#__codelineno-42-20"></a><span class="w">  </span><span class="nt">&quot;sources&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-42-21"><a id="__codelineno-42-21" name="__codelineno-42-21" href="#__codelineno-42-21"></a><span class="w">    </span><span class="nt">&quot;description&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;DeltaSource[file:/tmp/delta-change-data-feed/student]&quot;</span><span class="p">,</span>
</span><span id="__span-42-22"><a id="__codelineno-42-22" name="__codelineno-42-22" href="#__codelineno-42-22"></a><span class="w">    </span><span class="nt">&quot;startOffset&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span>
</span><span id="__span-42-23"><a id="__codelineno-42-23" name="__codelineno-42-23" href="#__codelineno-42-23"></a><span class="w">    </span><span class="nt">&quot;endOffset&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-42-24"><a id="__codelineno-42-24" name="__codelineno-42-24" href="#__codelineno-42-24"></a><span class="w">      </span><span class="nt">&quot;sourceVersion&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
</span><span id="__span-42-25"><a id="__codelineno-42-25" name="__codelineno-42-25" href="#__codelineno-42-25"></a><span class="w">      </span><span class="nt">&quot;reservoirId&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;77a3c27a-452c-47db-92bb-59b155a3fea2&quot;</span><span class="p">,</span>
</span><span id="__span-42-26"><a id="__codelineno-42-26" name="__codelineno-42-26" href="#__codelineno-42-26"></a><span class="w">      </span><span class="nt">&quot;reservoirVersion&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span>
</span><span id="__span-42-27"><a id="__codelineno-42-27" name="__codelineno-42-27" href="#__codelineno-42-27"></a><span class="w">      </span><span class="nt">&quot;index&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span>
</span><span id="__span-42-28"><a id="__codelineno-42-28" name="__codelineno-42-28" href="#__codelineno-42-28"></a><span class="w">      </span><span class="nt">&quot;isStartingVersion&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kc">false</span>
</span><span id="__span-42-29"><a id="__codelineno-42-29" name="__codelineno-42-29" href="#__codelineno-42-29"></a><span class="w">    </span><span class="p">},</span>
</span><span id="__span-42-30"><a id="__codelineno-42-30" name="__codelineno-42-30" href="#__codelineno-42-30"></a><span class="w">    </span><span class="nt">&quot;latestOffset&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span>
</span><span id="__span-42-31"><a id="__codelineno-42-31" name="__codelineno-42-31" href="#__codelineno-42-31"></a><span class="w">    </span><span class="nt">&quot;numInputRows&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">40</span><span class="p">,</span>
</span><span id="__span-42-32"><a id="__codelineno-42-32" name="__codelineno-42-32" href="#__codelineno-42-32"></a><span class="w">    </span><span class="nt">&quot;inputRowsPerSecond&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span>
</span><span id="__span-42-33"><a id="__codelineno-42-33" name="__codelineno-42-33" href="#__codelineno-42-33"></a><span class="w">    </span><span class="nt">&quot;processedRowsPerSecond&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mf">90.29345372460496</span>
</span><span id="__span-42-34"><a id="__codelineno-42-34" name="__codelineno-42-34" href="#__codelineno-42-34"></a><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="p">],</span>
</span><span id="__span-42-35"><a id="__codelineno-42-35" name="__codelineno-42-35" href="#__codelineno-42-35"></a><span class="w">  </span><span class="nt">&quot;sink&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-42-36"><a id="__codelineno-42-36" name="__codelineno-42-36" href="#__codelineno-42-36"></a><span class="w">    </span><span class="nt">&quot;description&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;org.apache.spark.sql.execution.streaming.ConsoleTable$@643c3322&quot;</span><span class="p">,</span>
</span><span id="__span-42-37"><a id="__codelineno-42-37" name="__codelineno-42-37" href="#__codelineno-42-37"></a><span class="w">    </span><span class="nt">&quot;numOutputRows&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">40</span>
</span><span id="__span-42-38"><a id="__codelineno-42-38" name="__codelineno-42-38" href="#__codelineno-42-38"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-42-39"><a id="__codelineno-42-39" name="__codelineno-42-39" href="#__codelineno-42-39"></a><span class="p">}</span>
</span></code></pre></div>
<p>You can also view the stages in the UI</p>
<p><img alt="delta-cdc-spark-ui" src="../pics/delta-cdc-spark-ui.png" /></p>
<p>In addition, there is provided streaming query statistics, showing metrics for CDC operations</p>
<p><img alt="delta-streaming-query-statistics" src="../pics/delta-streaming-query-statistics.png" /></p>
<h2 id="references">References<a class="headerlink" href="#references" title="Permanent link">#</a></h2>
<ul>
<li><a href="https://delta.io/">Delta Lake Official Documentation</a></li>
<li><a href="https://www.databricks.com/blog/2020/01/30/what-is-a-data-lakehouse.html">What is a Lakehouse?</a></li>
<li><a href="https://delta.io/blog/delta-lake-etl/">Delta Lake for ETL</a></li>
<li><a href="https://delta.io/blog/delta-lake-optimize/">Delta Lake Optimize</a></li>
<li><a href="https://medium.com/@ansabiqbal/delta-lake-introduction-with-examples-using-pyspark-cb2a0d7a549d">Delta Lake Introduction</a></li>
<li><a href="https://docs.databricks.com/en/delta/delta-change-data-feed.html">Use Delta Lake change data feed on Databricks</a></li>
</ul>







  
    
  
  
    
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Last update">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1-2.1-2M12.5 7v5.2l4 2.4-1 1L11 13V7h1.5M11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2v1.8Z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">July 13, 2024</span>
  </span>

    
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Created">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3h-2Z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">July 13, 2024</span>
  </span>

    
    
    
      
  <span class="md-source-file__fact">
    
      
  <span class="md-icon" title="Contributors">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34-.46-1.16-1.11-1.47-1.11-1.47-.91-.62.07-.6.07-.6 1 .07 1.53 1.03 1.53 1.03.87 1.52 2.34 1.07 2.91.83.09-.65.35-1.09.63-1.34-2.22-.25-4.55-1.11-4.55-4.92 0-1.11.38-2 1.03-2.71-.1-.25-.45-1.29.1-2.64 0 0 .84-.27 2.75 1.02.79-.22 1.65-.33 2.5-.33.85 0 1.71.11 2.5.33 1.91-1.29 2.75-1.02 2.75-1.02.55 1.35.2 2.39.1 2.64.65.71 1.03 1.6 1.03 2.71 0 3.82-2.34 4.66-4.57 4.91.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2Z"/></svg>
  </span>
  <span>GitHub</span>

    
    <nav>
      
        <a href="https://github.com/karlchris" class="md-author" title="@karlchris">
          
          <img src="https://avatars.githubusercontent.com/u/64395825?v=4&size=72" alt="karlchris">
        </a>
      
      
      
    </nav>
  </span>

    
  </aside>


  



  <form class="md-feedback" name="feedback" hidden>
    <fieldset>
      <legend class="md-feedback__title">
        Was this page helpful?
      </legend>
      <div class="md-feedback__inner">
        <div class="md-feedback__list">
          
            <button class="md-feedback__icon md-icon" type="submit" title="this page was helpful" data-md-value="1">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M5 9v12H1V9h4m4 12a2 2 0 0 1-2-2V9c0-.55.22-1.05.59-1.41L14.17 1l1.06 1.06c.27.27.44.64.44 1.05l-.03.32L14.69 8H21a2 2 0 0 1 2 2v2c0 .26-.05.5-.14.73l-3.02 7.05C19.54 20.5 18.83 21 18 21H9m0-2h9.03L21 12v-2h-8.79l1.13-5.32L9 9.03V19Z"/></svg>
            </button>
          
            <button class="md-feedback__icon md-icon" type="submit" title="This page could be improved" data-md-value="0">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 15V3h4v12h-4M15 3a2 2 0 0 1 2 2v10c0 .55-.22 1.05-.59 1.41L9.83 23l-1.06-1.06c-.27-.27-.44-.64-.44-1.06l.03-.31.95-4.57H3a2 2 0 0 1-2-2v-2c0-.26.05-.5.14-.73l3.02-7.05C4.46 3.5 5.17 3 6 3h9m0 2H5.97L3 12v2h8.78l-1.13 5.32L15 14.97V5Z"/></svg>
            </button>
          
        </div>
        <div class="md-feedback__note">
          
            <div data-md-value="1" hidden>
              
              
                
              
              Thanks for your feedback!
            </div>
          
            <div data-md-value="0" hidden>
              
              
                
              
              Thanks for your feedback! Help us improve this page by
            </div>
          
        </div>
      </div>
    </fieldset>
  </form>


                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var tab,labels=set.querySelector(".tabbed-labels");for(tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../spark-iceberg/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Apache Iceberg and PySpark">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Apache Iceberg and PySpark
              </div>
            </div>
          </a>
        
        
          
          <a href="../spark-hudi/" class="md-footer__link md-footer__link--next" aria-label="Next: Apache Hudi and Spark">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                Apache Hudi and Spark
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2024 Karl Christian

    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://www.linkedin.com/in/karllchris" target="_blank" rel="noopener" title="www.linkedin.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://github.com/karlchris" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://medium.com/@karl.christian" target="_blank" rel="noopener" title="medium.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M180.5 74.262C80.813 74.262 0 155.633 0 256s80.819 181.738 180.5 181.738S361 356.373 361 256 280.191 74.262 180.5 74.262Zm288.25 10.646c-49.845 0-90.245 76.619-90.245 171.095s40.406 171.1 90.251 171.1 90.251-76.619 90.251-171.1H559c0-94.503-40.4-171.095-90.248-171.095Zm139.506 17.821c-17.526 0-31.735 68.628-31.735 153.274s14.2 153.274 31.735 153.274S640 340.631 640 256c0-84.649-14.215-153.271-31.742-153.271Z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-progress" data-md-component="progress" role="progressbar"></div>
    
    
      <div class="md-consent" data-md-component="consent" id="__consent" hidden>
        <div class="md-consent__overlay"></div>
        <aside class="md-consent__inner">
          <form class="md-consent__form md-grid md-typeset" name="consent">
            

  
    
  


  
    
  



  


<h4>Cookie consent</h4>
<p>We use cookies to recognize your repeated visits and preferences, as well as to measure the effectiveness of our documentation and whether users find what they're searching for. With your consent, you're helping us to make our documentation better.</p>
<input class="md-toggle" type="checkbox" id="__settings" >
<div class="md-consent__settings">
  <ul class="task-list">
    
      
      
        
        
      
      <li class="task-list-item">
        <label class="task-list-control">
          <input type="checkbox" name="analytics" checked>
          <span class="task-list-indicator"></span>
          Google Analytics
        </label>
      </li>
    
      
      
        
        
      
      <li class="task-list-item">
        <label class="task-list-control">
          <input type="checkbox" name="github" checked>
          <span class="task-list-indicator"></span>
          GitHub
        </label>
      </li>
    
  </ul>
</div>
<div class="md-consent__controls">
  
    
      <button class="md-button md-button--primary">Accept</button>
    
    
    
  
    
    
    
      <label class="md-button" for="__settings">Manage settings</label>
    
  
</div>
          </form>
        </aside>
      </div>
      <script>var consent=__md_get("__consent");if(consent)for(var input of document.forms.consent.elements)input.name&&(input.checked=consent[input.name]||!1);else"file:"!==location.protocol&&setTimeout(function(){document.querySelector("[data-md-component=consent]").hidden=!1},250);var action,form=document.forms.consent;for(action of["submit","reset"])form.addEventListener(action,function(e){if(e.preventDefault(),"reset"===e.type)for(var n of document.forms.consent.elements)n.name&&(n.checked=!1);__md_set("__consent",Object.fromEntries(Array.from(new FormData(form).keys()).map(function(e){return[e,!0]}))),location.hash="",location.reload()})</script>
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.instant", "navigation.instant.prefetch", "navigation.instant.progress", "navigation.instant.preview", "navigation.tracking", "navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "navigation.expand", "navigation.path", "navigation.indexes", "navigation.top", "navigation.footer", "toc.extend", "toc.follow", "content.code.copy", "content.code.select", "content.code.annotate", "content.tabs.link", "content.action.edit", "content.action.view", "search.suggest", "search.highlight", "search.share"], "search": "../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.081f42fc.min.js"></script>
      
    
  </body>
</html>